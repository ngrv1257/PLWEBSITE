<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Amar Font Converter</title>

<!-- ================= FIREBASE SDK ================= -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- ================= OPTIONAL DOCX SUPPORT ================= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
/* ========== GLOBAL ========== */


@font-face {
  font-family: 'AmrHindi';
  src: url('./fonts/AmrHindi.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

/* ===== OUTPUT FONT MODES ===== */
.font-amar {
  font-family: 'AmrHindi', monospace;
  font-size: 18px;
  line-height: 1.6;
}

.font-hindi {
  font-family: Mangal, Nirmala UI, Kokila, Arial, sans-serif;
  font-size: 16px;
  line-height: 1.6;
}

.font-english {
  font-family: Arial, Helvetica, sans-serif;
  font-size: 15px;
  line-height: 1.6;
}




body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e3c72,#f5c542);
  min-height:100vh;
}

/* ========== AUTH UI ========== */
#authScreen{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
.authBox{
  width:420px;
  max-width:95%;
  padding:28px;
  background:rgba(255,255,255,.25);
  backdrop-filter:blur(14px);
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.25);
}
input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:none;
}
.passWrap{ position:relative; }
.eye{
  position:absolute;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  cursor:pointer;
}
canvas{
  display:block;
  width:100%;
  height:48px;
  border-radius:8px;
  background:#fff;
  margin-bottom:10px;
}
button{
  padding:12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.primary{ background:#1e3c72;color:#fff; }
.secondary{ background:#f5c542;color:#000; }
.btnRow{ display:flex; gap:10px; }
.tc{ font-size:13px; }

/* ========== ENGINE WRAPPER ========== */
#engine{
  display:none;
  background:#f3f3f3;
  min-height:100vh;
}
</style>
</head>

<body>

<!-- ================= AUTH SCREEN ================= -->
<div id="authScreen">
  <div class="authBox">

    <h2 id="formTitle">Login</h2>

    <input id="email" type="email" placeholder="Email">

    <div class="passWrap">
      <input id="password" type="password" placeholder="Password">
      <span class="eye" onclick="togglePwd('password')">üëÅ</span>
    </div>

    <div class="passWrap" id="confirmWrap" style="display:none;">
      <input id="confirmPassword" type="password" placeholder="Confirm Password">
      <span class="eye" onclick="togglePwd('confirmPassword')">üëÅ</span>
    </div>

    <p style="text-align:right;font-size:13px;">
      <a href="#" onclick="forgotPassword()">Forgot password?</a>
    </p>

    <!-- CAPTCHA -->
    <canvas id="captchaCanvas"></canvas>
    <input id="captchaInput" placeholder="Enter CAPTCHA">
    <button class="secondary" onclick="refreshCaptcha()">‚Üª Refresh</button>

    <!-- T&C -->
    <label class="tc" id="tncWrap" style="display:none;">
      <input type="checkbox" id="acceptTnc">
      By clicking the box, I accept the <a href="terms.html" target="_blank">Terms & Conditions</a>
    </label>

    <p id="verifyMsg" style="display:none;font-size:13px;text-align:center;color:#1e3c72;">
      ‚úÖ Account created successfully.<br>
      Please check your email and verify to login.
    </p>

    <div class="btnRow">
      <button class="primary" id="submitBtn" onclick="submitForm()">Login</button>
      <button class="secondary" id="switchBtn" onclick="switchMode()">Create Account</button>
    </div>

    <p id="msg" style="color:#c00;font-size:13px;text-align:center;"></p>
  </div>
</div>

<!-- ================= ENGINE ================= -->
<div id="engine">

  <!-- üîΩüîΩüîΩ PASTE YOUR **ENTIRE AMAR ENGINE HTML HERE** üîΩüîΩüîΩ -->
  <!-- Everything from <div class="container"> till your footer -->
  <!-- DO NOT include <body>, <html>, or Firebase scripts -->


<style>
    .container {
    max-width: 960px;
    margin: 20px auto;
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
    margin-bottom: 10px;
  }
  textarea {
    width: 100%;
    min-height: 140px;
    font-size: 16px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    resize: vertical;
  }
  .btn-row {
    margin: 10px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  button {
    flex: 1;
    min-width: 140px;
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    background: #111;
    color: #fff;
    font-size: 15px;
    cursor: pointer;
  }
  button:hover {
    background: #333;
  }
  hr {
    margin: 24px 0;
  }
  @media (max-width: 600px) {
    button { flex: 100%; }
  }

/* ================= TOP AREAS FLEX ================= */
.topAreasWrap{
  max-width:960px;
  margin:16px auto;
  display:flex;
  flex-wrap:wrap;
  gap:16px;
}

.areaCard{
  width:calc(50% - 8px);
  background:#ffffff;
  border-radius:12px;
  padding:16px;
  text-align:center;
  font-weight:600;
  box-shadow:0 4px 14px rgba(0,0,0,0.1);
}

.areaCard.areaFull{
  width:100%;
}



</style>

<div style="text-align:right; margin-bottom:10px;">
  <button onclick="logout()" style="
    background:#c0392b;
    color:#fff;
    border:none;
    padding:8px 14px;
    border-radius:6px;
    cursor:pointer;
    font-size:13px;
  ">
    üö™ Logout
  </button>
</div>


<!-- ================= PLAN STATUS BAR ================= -->
<div id="planBar" style="
  max-width:960px;
  margin:10px auto;
  padding:14px 16px;
  background:#1e3c72;
  color:#fff;
  border-radius:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px;
">
  <div>
    <strong>Plan:</strong>
    <span id="planName">Free</span>
    <span id="planMeta" style="opacity:.85; margin-left:8px;">
      (Per Day Limit : 500 chars ¬∑ 2 conversions ¬∑ 0 DOCX)
    </span>
  </div>

  <button id="upgradeBtn" disabled style="
    background:#f5c542;
    color:#000;
    border:none;
    padding:6px 12px;
    border-radius:6px;
    font-size:13px;
    cursor:not-allowed;
    opacity:.7;
  ">
    Upgrade (Coming Soon)
  </button>
</div>




<!-- ================= USAGE BAR ================= -->

<div id="charLimitBar" style="
  max-width:960px;
  margin:12px auto;
  padding:12px 16px;
  background:#fff;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  font-size:13px;
">
  <div style="display:flex;justify-content:space-between;">
    <strong>Daily Character Usage</strong>
    <span id="charText">0 / 500</span>
  </div>

  <div style="
    margin-top:8px;
    height:8px;
    background:#eee;
    border-radius:6px;
    overflow:hidden;
  ">
    <div id="charFill" style="
      height:100%;
      width:0%;
      background:#4caf50;
      transition:width .3s;
    "></div>
  </div>

  <div id="charWarn" style="
    display:none;
    margin-top:6px;
    color:#c0392b;
    font-size:12px;
  ">
    ‚ö† You are close to your daily limit.
  </div>
</div>



<!-- ================= SUBSCRIPTION PLAN UI ================= -->
<div id="planBox" style="
  max-width:960px;
  margin:16px auto;
  padding:16px;
  background:#ffffff;
  border-radius:12px;
  box-shadow:0 4px 14px rgba(0,0,0,.1);
">

  <div style="display:flex;justify-content:space-between;align-items:center;">
    <strong>Your Plan</strong>
    <span id="currentPlanBadge"
      style="padding:4px 10px;border-radius:12px;font-size:12px;background:#e0e0e0;">
      Free
    </span>
  </div>

  <div style="margin-top:12px;">
<button
  id="planHintBtn"
  onclick="togglePlanDropdown()"
  style="
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px dashed #999;
    background:#fafafa;
    color:#555;
    font-size:14px;
    cursor:pointer;
  ">
  Click to see all the plans & UPGRADE for More Benefits!! ‚ñº
</button>

  </div>

  <div id="planDropdown" style="display:none;margin-top:12px;">

<!-- FREE -->
<div class="planItem" onclick="selectPlan('free')">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <strong>Free</strong>
    <strong>‚Çπ0 / month*</strong>
  </div>
  <div class="planMeta">Per Day Limit : 500 chars ¬∑ 2 text-box conversions ¬∑ 0 Ms-Word- *.Docx file Upload Conversion</div>
</div>

<!-- BASIC -->
<div class="planItem" onclick="selectPlan('basic')">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <strong>Basic</strong>
    <strong>‚Çπ200 / month*</strong>
  </div>
  <div class="planMeta">Per Day Limit : 1,000 chars ¬∑ 10 text-box conversions ¬∑ 2 Ms-Word- *.Docx file Upload Conversion</div>
</div>

<!-- PREMIUM -->
<div class="planItem" onclick="selectPlan('premium')">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <strong>Premium</strong>
    <strong>‚Çπ500 / month*</strong>
  </div>
  <div class="planMeta">Per Day Limit :  UNLIMITED USAGE !!</div>
</div>

    <button id="buyPlanBtn"
      onclick="proceedToBuy()"
      disabled
      style="
        width:100%;
        margin-top:12px;
        padding:10px;
        border-radius:8px;
        border:none;
        background:#1e3c72;
        color:#fff;
        opacity:.5;
        cursor:not-allowed;
      ">
      Proceed to Buy
    </button>

  </div>
</div>


<style>
.planItem{
  padding:10px;
  border:1px solid #ddd;
  border-radius:8px;
  margin-bottom:8px;
  cursor:pointer;
}
.planItem:hover{
  background:#f7f7f7;
}
.planMeta{
  font-size:12px;
  color:#555;
}
</style>

<script>
let selectedPlan = null;

const PLAN_META = {
  free:    "500 chars ¬∑ 2 conversions ¬∑ 0 DOCX / day",
  basic:   "1,000 chars ¬∑ 10 conversions ¬∑ 2 DOCX / day",
  premium: "Unlimited usage"
};


function togglePlanDropdown(){
  const d = document.getElementById("planDropdown");
  d.style.display = d.style.display === "none" ? "block" : "none";
}

function selectPlan(plan){
  selectedPlan = plan;

  document.getElementById("currentPlanBadge").innerText =
    plan.charAt(0).toUpperCase() + plan.slice(1);

  const btn = document.getElementById("buyPlanBtn");

  if(plan === "free"){
    btn.disabled = true;
    btn.style.opacity = ".5";
    btn.style.cursor = "not-allowed";
    btn.innerText = "Free Plan (Active)";
  } else {
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
    btn.innerText = `Proceed to Buy ${plan.charAt(0).toUpperCase()+plan.slice(1)}`;
  }
}

function proceedToBuy(){
  if(!selectedPlan || selectedPlan === "free") return;

  alert(
    `Proceeding to buy plan: ${selectedPlan.toUpperCase()}\n\n` +
    PLAN_META[selectedPlan]
  );

  // üîú NEXT STEP: Razorpay integration will go here
}
</script>



<div class="container">
  <h2>Font Converter : English  ‚áÑ Hindi(Unicode) ‚Üí Amar Hindi(Legacy)</h2>

  <label><b>Input Text:</b></label>
  <textarea id="unicodeInput" placeholder="Type or paste Unicode text here..."></textarea>

<!-- ================= OUTPUT MODE ================= -->
<div style="margin:10px 0;">
  <label><b>Output Format:</b></label>
  <select id="outputMode" style="
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:14px;
  ">
    <!-- options injected dynamically -->
  </select>
</div>





<div id="langWarn" style="
  display:none;
  margin-bottom:10px;
  color:#c0392b;
  font-size:13px;
  font-weight:500;
"></div>





  <div class="btn-row">
    <button onclick="handleUnicodeToAmar()">Click to Convert Text</button>

    <button onclick="copyAmar()">Copy Output Text</button>
  </div>

  <label><b>Translated Output:</b></label>
  <textarea id="amarOutput" placeholder="Output will appear here..."></textarea>

  <hr>

<h3>Upload  Input File ‚Üí Download File with Translation  (Only Ms-Word- *.docx supported)</h3>

<input type="file" id="docxFile" accept=".docx" />

<!-- ================= DOCX LANGUAGE STATUS (STEP A) ================= -->
<div id="docxLangBox" style="
  display:none;
  margin-top:12px;
  padding:12px;
  border-radius:10px;
  background:#f7f7f7;
  border:1px solid #ccc;
  font-size:14px;
">

  <div style="margin-bottom:8px;">
    <strong>Detected DOCX Language:</strong>
    <span id="docxDetectedLang" style="margin-left:6px;"></span>
  </div>

  <div>
    <strong>Output Format:</strong>
    <select id="docxOutputMode" style="
      width:100%;
      margin-top:6px;
      padding:10px;
      border-radius:8px;
      border:1px solid #bbb;
    ">
      <!-- options injected dynamically -->
    </select>
  </div>
</div>

<button id="docxConvertBtn" onclick="convertDocx()" disabled
  style="opacity:.5;cursor:not-allowed;margin-top:12px;">
  Convert & Download DOCX
</button>


</div>

<script>


/* ============================================================
   PART 1 ‚Äì BASE SIMPLE LETTER MAPPING (MAP_LETTERS)
============================================================ */
const MAP_LETTERS = {
  "‡§ï":"k","‡§ñ":"K","‡§ó":"g","‡§ò":"G","‡§ô":"|",
  "‡§ö":"c","‡§õ":"C","‡§ú":"j","‡§ù":"J","‡§û":"\\",
  "‡§ü":"t","‡§†":"T","‡§°":"f","‡§¢":"F","‡§£":"x",
  "‡§§":"q","‡§•":"Q","‡§¶":"d","‡§ß":"D","‡§®":"n",
  "‡§™":"p","‡§´":"P","‡§¨":"b","‡§≠":"B","‡§Æ":"m",
  "‡§Ø":"X","‡§∞":"r","‡§≤":"l","‡§µ":"v",
  "‡§∂":"S","‡§∑":"‚Ä†","‡§∏":"s","‡§π":"h",

  "‡§Ü":"Aw","‡§Ö":"A","‡§á":"e","‡§à":"e~",
  "‡§â":"a","‡§ä":"‚Äö","‡§è":"E","‡§ê":"Ey","‡§ì":"Ao","‡§î":"AO",

  "‡§Ç":"<","‡§Å":">","‡§æ":"w","‡§ø":"i","‡•Ä":"I","‡•Å":"u","‡•Ç":"U",
  "‡•á":"y","‡•à":"Y","‡•ã":"o","‡•å":"O","‡•É":"√∑",

  "‡•§":"[","‡••":"[[","-":"-","=":"=",
  "‡•¶":"0","‡•ß":"1","‡•®":"2","‡•©":"3","‡•™":"4",
  "‡•´":"5","‡•¨":"6","‡•≠":"7","‡•Æ":"8","‡•Ø":"9",
  "‡§º":"¬°","‡§±":"X¬°"
};

/* ============================================================
   PART 2 ‚Äì HALF-CONSONANTS SET A (MAP_HALFA)
   Used when ANY consonant follows after halant
============================================================ */
const MAP_HALFA = {
  "‡§ï‡•ç":"#","‡§ñ‡•ç":"$","‡§ó‡•ç":"^","‡§ò‡•ç":"%","‡§ô‡•ç":"√ß","‡§ö‡•ç":"√á","‡§õ‡•ç":"C",
  "‡§ú‡•ç":"√à","‡§ù‡•ç":"√â","‡§û‡•ç":"√ä","‡§ü‡•ç":"√®","‡§†‡•ç":"T`","‡§°‡•ç":"√©","‡§¢‡•ç":"F",
  "‡§£‡•ç":"&","‡§§‡•ç":"√ã","‡§•‡•ç":"√å","‡§ß‡•ç":"√ç","‡§®‡•ç":"N","‡§™‡•ç":"√é","‡§∂‡•ç‚Äç":"√ú","‡§∏‡•ç":"√°","‡§∑‡•ç":"√†",
  "‡§´‡•ç":"√è","‡§¨‡•ç":"√ë","‡§Æ‡•ç":"M","‡§≠‡•ç":"√í","‡§≤‡•ç":"√ò","‡§µ‡•ç":"√õ","‡§µ‡•ç":"√õ","‡§µ‡•ç":"√õ","‡§µ‡•ç":"√õ",
  "‡§∞‡•ç":"r`"   // reph form
};

/* ============================================================
   PART 3 ‚Äì HALF-CONSONANTS SET B (MAP_HALFB)
   Used when NO consonant follows after halant
============================================================ */
const MAP_HALFB = {
  "‡§ï‡•ç":"k`","‡§ñ‡•ç":"K`","‡§ó‡•ç":"g`","‡§ò‡•ç":"G`","‡§ô‡•ç":"|`",
  "‡§ö‡•ç":"c`","‡§õ‡•ç":"C`","‡§ú‡•ç":"j`","‡§ù‡•ç":"J`","‡§û‡•ç":"\\`",
  "‡§ü‡•ç":"t`","‡§†‡•ç":"T`","‡§°‡•ç":"f`","‡§¢‡•ç":"F`","‡§£‡•ç":"x`",
  "‡§§‡•ç":"q`","‡§•‡•ç":"Q`","‡§¶‡•ç":"d`","‡§ß‡•ç":"D`","‡§®‡•ç":"n`",
  "‡§™‡•ç":"p`","‡§´‡•ç":"P`","‡§¨‡•ç":"b`","‡§≠‡•ç":"B`","‡§Æ‡•ç":"m`",
  "‡§Ø‡•ç":"X`","‡§∞‡•ç‡§ï‡•ç":"k~`","‡§≤‡•ç":"l`","‡§µ‡•ç":"v`",
  "‡§∂‡•ç":"S`","‡§∑‡•ç":"‚Ä†`","‡§∏‡•ç":"s`","‡§π‡•ç":"h`"
};

/* ============================================================
   PART 4 ‚Äì CONJUNCTS (MAP_CONJ)
   Highest priority after words
============================================================ */

const MAP_CONJ = {

  /* ==== Existing approved conjuncts ==== */
  "‡§ï‡•ç‡§ï":"Àú","‡§¶‡•ç‡§ó":"√™√Æ","‡§¶‡•ç‡§ò":"√™√≤","‡§¶‡•ç‡§¶":"¬®","‡§¶‡•ç‡§¨":"√™√¥","‡§¶‡•ç‡§≠":"√™B","‡§∑‡•ç‡§ü‡•ç‡§∞":"√†t√∂",

  /* ==== Complex clusters ==== */
  "‡§Ö‡§∏‡•ç‡§§‡§ø‡§§‡•ç‡§µ":"Ai√°q√ãv","‡§ï‡•É‡§§‡•ç‡§∞‡•ç‡§Ø":"‚Ñ¢√£X",
  "‡§ï‡•ç‡§∑‡•ç‡§ü‡•ç‡§∞‡§ø":"i√¢t√∂","‡§ï‡•ç‡§∑‡•ç‡§£‡§ø":"i√¢x","‡§ï‡•ç‡§∑‡•ç‡§™‡•ç‡§∞‡§ø":"i√¢pR","‡§ï‡•ç‡§∑‡•ç‡§Æ‡•ç‡§Ø‡§ø":"i√¢MX",
  "‡§ö‡§ø‡§§‡•ç‡§∞":"icZ","‡§ö‡§ø‡§®‡•ç‡§§":"icNq","‡§ö‡§ø‡§®‡•ç‡§§‡§æ":"icNqw",
  "‡§ú‡•ç‡§û‡•ç‡§§‡•ç‡§∞‡§ø":"i√•Z","‡§ú‡•ç‡§û‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√•~X","‡§ú‡•ç‡§û‡•ç‡§∏‡•ç‡§§‡•ç‡§∞‡§ø":"i√•√°Z",
  "‡§§‡•ç‡§∞‡§ø‡§∑‡•ç‡§ü":"iZ√†t","‡§¶‡§ø‡§ï‡•ç‡§∑":"id@","‡§¶‡•Ä‡§ï‡•ç‡§∑‡§ø‡§§":"dIi@q",
  "‡§¶‡•É‡§∑‡•ç‡§ü‡§ø":"d√∑i√†t",
  "‡§¶‡•ç‡§ß‡•ç‡§∞‡§ø":"i¬©R","‡§¶‡•ç‡§ß‡•ç‡§∞‡•ç‡§Ø‡§ø":"i¬©R√î","‡§∞‡•ç‡§∂‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√ú√£X~","‡§∞‡•ç‡§∂‡•ç‡§ö‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√úcR√î~",

  "‡§ò‡•ç‡§®":"%n","‡§¶‡•ç‡§ß":"¬©",

"‡§∞‡•ç‡§≤‡•ç‡§ï‡•ç‡§∞‡§ø":"i√òk√µ~","‡§∞‡•ç‡§≤‡•ç‡§™‡§ø":"i√òp~","‡§∞‡•ç‡§µ‡•ç‡§Ø‡§ø":"i√õX~","‡§∞‡•ç‡§∂‡§ø":"iS~","‡§∞‡•ç‡§∂‡•ç‡§ö‡§ø":"i√úc~","‡§∞‡•ç‡§∂‡•ç‡§∞‡§ø":"i‚Ä∞~","‡§∞‡•ç‡§∂‡•ç‡§∞‡•ç‡§Ø‡§ø":"i‚Ä∞√î~","‡§∞‡•ç‡§∑‡§ø":"i‚Ä†~","‡§∞‡•ç‡§∑‡•ç‡§ü‡§ø":"i√†t~","‡§∞‡•ç‡§∑‡•ç‡§ü‡•ç‡§∞‡§ø":"i√†t√∂~","‡§∞‡•ç‡§∑‡•ç‡§ü‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√†t√∂√î~","‡§∞‡•ç‡§∑‡•ç‡§ü‡•ç‡§∏‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√†√®√°√£X~","‡§∞‡•ç‡§∑‡•ç‡§†‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√Ñ√∂√î~","‡§∞‡•ç‡§∑‡•ç‡§£‡§ø":"i√†x~","‡§∞‡•ç‡§∑‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√†√£X~","‡§∞‡•ç‡§∏‡§ø":"is~",
"‡§∞‡•ç‡§∏‡•ç‡§§‡•ç‡§®‡•ç‡§Ø‡§ø":"i√°√ãNXs~","‡§∞‡•ç‡§∏‡•ç‡§™‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√°pR√î~","‡§∞‡•ç‡§§‡•ç‡§Æ‡•ç‡§Ø‡§ø":"i√ãMX~","‡§∞‡•ç‡§¶‡•ç‡§≠‡•ç‡§∞‡§ø":"i√™BR~","‡§∞‡•ç‡§™‡•ç‡§§‡•ç‡§∞‡§ø":"i√éZ~","‡§∞‡•ç‡§¨‡•ç‡§ß‡•ç‡§∞‡§ø":"i√ëDR~","‡§∞‡•ç‡§´‡•ç‡§∞‡•ç‡§Ø‡§ø":"iP√µ√î~",

  /* ==== r + i clusters (deduplicated) ==== */
  "‡§∞‡•ç‡§ï‡§ø":"ik~","‡§∞‡•ç‡§ï‡•ç‡§§‡§ø":"i√Ç~","‡§∞‡•ç‡§ï‡•ç‡§§‡•ç‡§∞‡§ø":"i√ÇR~","‡§∞‡•ç‡§ï‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√ÇR√î~",
  "‡§∞‡•ç‡§ï‡•ç‡§∞‡§ø":"ik√µ~","‡§∞‡•ç‡§ï‡•ç‡§≤‡§ø":"i‚Ä∫~","‡§∞‡•ç‡§ï‡•ç‡§∑‡§ø":"i@~",
  "‡§∞‡•ç‡§ï‡•ç‡§∑‡•ç‡§ü‡•ç‡§∞‡§ø":"i√¢t√∂~","‡§∞‡•ç‡§ï‡•ç‡§∑‡•ç‡§ü‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√¢t√∂√î~",
  "‡§∞‡•ç‡§ï‡•ç‡§∑‡•ç‡§£‡§ø":"i√¢x~","‡§∞‡•ç‡§ï‡•ç‡§∑‡•ç‡§£‡•ç‡§Ø‡§ø":"i√¢&X~",

  "‡§∞‡•ç‡§ö‡§ø":"ic~","‡§∞‡•ç‡§ö‡•ç‡§õ‡§ø":"i√áC~","‡§∞‡•ç‡§ö‡•ç‡§Ø‡§ø":"i√áX~","‡§∞‡•ç‡§ö‡•ç‡§∞‡§ø":"icR~",

  "‡§∞‡•ç‡§ù‡§ø":"iJ~","‡§∞‡•ç‡§ù‡•ç‡§∞‡§ø":"iJR~",
  "‡§∞‡•ç‡§û‡§ø":"i\\~","‡§∞‡•ç‡§û‡•ç‡§ö‡§ø":"i√äc~",

  "‡§∞‡•ç‡§°‡§ø":"if~","‡§∞‡•ç‡§°‡•ç‡§ß‡§ø":"i√©D~","‡§∞‡•ç‡§°‡•ç‡§∞‡§ø":"if√∂~",

  "‡§∞‡•ç‡§£‡§ø":"ix~","‡§∞‡•ç‡§£‡•ç‡§ü‡§ø":"i&t~","‡§∞‡•ç‡§£‡•ç‡§°‡§ø":"i&f~",

  "‡§∞‡•ç‡§™‡§ø":"ip~","‡§∞‡•ç‡§™‡•ç‡§§‡§ø":"i√éq~","‡§∞‡•ç‡§™‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√é√£X~","‡§∞‡•ç‡§™‡•ç‡§∞‡§ø":"ipR~",

  "‡§∞‡•ç‡§´‡§ø":"iP~","‡§∞‡•ç‡§´‡•ç‡§∞‡§ø":"iP√µ~",

  "‡§∏‡•É‡§∑‡•ç‡§ü‡§ø":"s√∑i√†t",
"‡§ú‡§É":"j√ö","‡§∞‡§É":"r√ö","‡§®‡§É":"n√ö","‡§ï‡•ç‡§∑‡•ç‡§Ø":"√¢X","‡§ú‡•ç‡§û‡§™‡•ç‡§§‡§ø‡§É":"zi√éq√ö","‡§ô‡•ç‡§ï‡•ç‡§∑‡•ç‡§µ":"√ß√´`√†v","‡§∑‡•ç‡§ü‡•ç‡§∞‡•ç‡§Ø":"√†t√∂√î","‡§≠‡•ç‡§∞‡§Ç‡§∂‡•ç‡§§‡•ç‡§∞":"BR<√úZ",

  /* ==== base conjuncts ==== */
  "‡§™‡•ç‡§∞":"pR","‡§§‡•ç‡§∞":"Z","‡§ú‡•ç‡§û":"z","‡§∂‡•ç‡§∞":"‚Ä∞",
  "‡§¶‡•ç‡§Ø":"¬¥","‡§¶‡•ç‡§Ø‡•Å":"¬¥u",
  "‡§∏‡•ç‡§§‡•ç‡§∞":"√°Z","‡§Æ‡•ç‡§®":"Mn","‡§ó‡•ç‡§®":"^n",
  "‡§ï‡•ç‡§§":"√Ç","‡§∏‡•ç‡§µ":"√°v","‡§ï‡•ç‡§∑":"@","‡§ó‡•ç‡§∞":"gR",

  /* ==== ‡§ë series ==== */
  "‡§ï‡•ç‡§§‡•â":"√Çw","‡§§‡•ç‡§∞‡•â":"Zw","‡§¶‡•ç‡§∞‡•â":"dRw","‡§ï‡•ç‡§∞‡•â":"k√µw","‡§ó‡•ç‡§∞‡•â":"gRw",
  "‡§™‡•ç‡§∞‡•â":"pRw","‡§¨‡•ç‡§∞‡•â":"bRw","‡§ß‡•ç‡§∞‡•â":"DRw","‡§∂‡•ç‡§∞‡•â":"‚Ä∞w",

  "‡§ï‡•â":"kw","‡§ñ‡•â":"Kw","‡§ó‡•â":"gw","‡§ò‡•â":"Gw","‡§ô‡•â":"|w",
  "‡§ö‡•â":"cw","‡§õ‡•â":"Cw","‡§ú‡•â":"jw","‡§ù‡•â":"Jw","‡§û‡•â":"\\w",

  "‡§ü‡•â":"tw","‡§†‡•â":"Tw","‡§°‡•â":"fw","‡§¢‡•â":"Fw","‡§£‡•â":"xw",
  "‡§§‡•â":"qw","‡§•‡•â":"Qw","‡§¶‡•â":"dw","‡§ß‡•â":"Dw","‡§®‡•â":"nw",

  "‡§™‡•â":"pw","‡§´‡•â":"Pw","‡§¨‡•â":"bw","‡§≠‡•â":"Bw","‡§Æ‡•â":"mw",
  "‡§Ø‡•â":"Xw","‡§∞‡•â":"rw","‡§≤‡•â":"lw","‡§µ‡•â":"vw",
  "‡§∂‡•â":"Sw","‡§∑‡•â":"‚Ä†w","‡§∏‡•â":"sw","‡§π‡•â":"hw",

  /* --- final --- */
  "‡§£‡•ç‡§Ø":"&X"
};


// ZWJ-variant conjuncts for Word-style sequences (e.g. ‡§§‡•ç‚Äç‡§∞, ‡§∏‡•ç‚Äç‡§µ)
const MAP_CONJ_ZWJ = {};
for (const key in MAP_CONJ) {
  if (key.includes("‡•ç")) {
    // Insert ZWJ (U+200D) after every halant
    const zwjKey = key.replace(/‡•ç/g, "‡•ç‚Äç");  // halant + ZWJ
    MAP_CONJ_ZWJ[zwjKey] = MAP_CONJ[key];
  }
}


/* ============================================================
   PART 5 ‚Äì WORD EXCEPTIONS (MAP_WORDS)
   Absolute top priority
============================================================ */
const MAP_WORDS = {
  "‡§§‡•ç‡§∞‡§ø‡§ï‡•Ç‡§ü":"iZkUt","‡§∞‡•Å":"{","‡§§‡•ç‡§∞‡§ø‡§™‡•É‡§∑‡•ç‡§†":"iZp√∑√Ñ","‡§§‡•ç‡§∞‡§ø‡§µ‡•á‡§£‡•Ä":"iZvyxI","‡§ï‡•ç‡§≤‡•ç‡§Ø‡•å":"‚Ä∫√îO","‡§∞‡•Ç":"}",
"‡§§‡•ç‡§∞‡§ø‡§∂‡•Ç‡§≤":"iZSUl","‡§§‡•ç‡§µ‡•ç‡§Ø":"√ã√õX","‡§ã‡§∑‡•Ä":"ÀÜ‚Ä†I","‡§∑‡•Ä":"‚Ä†I","‡§Æ‡•ç‡§∞":"mR","‡§∏‡•ç‡§§‡•ç‡§∞‡•à‡§£‡•ç‡§Ø":"√°ZY&X","‡§ï‡•ç‡§Ø":"#X","‡§£‡•ç‡§Ø":"&X","‡§¶‡•ç‡§≠‡•ç‡§∞":"√™BR","‡§ï‡•ç‡§∑‡•ç‡§Æ‡•ç‡§Ø":"√¢MX","‡§∏‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø‡§É":"√°√£X√ö","‡§†‡•ç‡§Ø‡§ï‡•ç‡§∞":"T√îk√µ","‡§∞‡•ç‡§∑‡§ø":"i‚Ä†~",
  "‡§§‡•ç‡§∞‡§æ‡§∏‡§¶‡•Ä":"ZwsdI","‡§ú‡•ç‡§û‡§æ‡§®‡•á‡§∂‡•ç‡§µ‡§∞":"zwny√úvr","‡§ú‡•ç‡§û‡§æ‡§®‡§ï‡•ã‡§∂":"zwnkoS","‡§∞‡•ç‡§£":"x~","‡§∞‡•ç‡§£‡•ç‡§Ø":"&X~","‡§∞‡•ç‡§£‡•ç‡§µ":"&v~","‡§∞‡•ç‡§£‡•ç‡§Æ":"&m~","‡§∞‡•ç‡§£‡•ç‡§®":"&n~","‡§¶‡•ç‡§ò‡•ç‡§®‡•ç‡§Ø":"√™√≤√≥√î",
  "‡§∞‡•ç‡§£‡•ç‡§°":"&f~","‡§∞‡•ç‡§£‡•ç‡§ß":"&D~","‡§∞‡•ç‡§£‡•ç‡§ó":"&g~","‡§∞‡•ç‡§£‡•ç‡§ï":"&k~","‡§∞‡•ç‡§£‡•ç‡§†":"&T~","‡§∞‡•ç‡§£‡•ç‡§ü":"&t~","‡§∞‡•ç‡§£‡•ç‡§™":"&p~","‡§∞‡•ç‡§£‡•ç‡§≠":"&B~","‡§∞‡•ç‡§£‡•ç‡§∏":"&s~","‡§∞‡•ç‡§£‡•ç‡§Ø":"&X~",
  "‡§∞‡•ç‡§£‡•ç‡§∑":"&‚Ä†~","‡§∞‡•ç‡§£‡•ç‡§ú":"&j~","‡§∞‡•ç‡§£‡•ç‡§§":"&q~","‡§∞‡•ç‡§£‡•ç‡§Æ‡•ç‡§Ø":"&MX~","üî• ":"üî• ","‡§∞‡•ç‡§®‡•ç‡§Ø":"NX~","‡§∞‡•ç‡§Æ‡•ç‡§Ø":"MX~","‡§∞‡•ç‡§∏‡•ç‡§Ø":"√°X~","‡§∞‡•ç‡§§‡•ç‡§Ø":"√ãX~","‡§∞‡•ç‡§•‡•ç‡§Ø":"√åX~","‡§∞‡•ç‡§ú‡•ç‡§Ø":"√àX~","‡§∞‡•ç‡§ï‡•ç‡§Ø":"#X~","‡§∞‡•ç‡§µ‡•ç‡§Ø":"√õX~","‡§∞‡•ç‡§ò‡•ç‡§Ø":"%X~","‡§∞‡•ç‡§π‡•ç‡§Ø":"HX~",
  "‡§µ‡§ø‡§ú‡•ç‡§û‡§™‡•ç‡§§‡§ø":"ivzi√éq","‡§™‡•ç‡§∞‡§ú‡•ç‡§û‡§æ":"pRzw","‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ":"s<zw",
  "‡§ï‡•ç‡§∑‡§∞‡§£":"@rx","‡§ï‡•ç‡§∑‡§§‡•ç‡§∞‡§ø‡§Ø":"@iZX","‡§ï‡•ç‡§∑‡§Æ‡§æ‡§∂‡•Ä‡§≤":"@mwSIl",
  "‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü":"a√ã‚Ñ¢√†t","‡§ï‡•É‡§∑‡•ç‡§£":"‚Ñ¢√†x","‡§Ö‡§ï‡•ç‡§∑‡§∞":"A@r",
  "‡§∂‡•ç‡§∞‡§µ‡§£":"‚Ä∞vx","‡§∂‡•ç‡§∞‡•á‡§Ø‡§æ":"‚Ä∞yXw","‡§∂‡•ç‡§∞‡§Æ‡§ø‡§ï":"‚Ä∞imk",
  "‡§∂‡•ç‡§∞‡•á‡§Ø‡§∏‡•ç‡§ï‡§∞":"‚Ä∞yX√°kr","‡§∂‡•ç‡§∞‡§¶‡•ç‡§ß‡§æ":"‚Ä∞¬©w",
  "‡§µ‡§ø‡§¶‡•ç‡§Ø‡•Å‡§§":"iv¬¥uq","‡§®‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§≤‡§Ø":"NXwXwlX","‡§â‡§¶‡•ç‡§Ø‡§æ‡§®":"a¬¥wn","‡§¶‡•ç‡§Ø‡•Å‡§§‡§ø":"¬¥uiq",
  "‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§§‡•ç‡§Æ":"A√çXw√ãm","‡§ß‡•ç‡§Ø":"√çX","‡§ß‡•ç‡§Ø‡§æ‡§®":"√çXwn",
  "‡§Ö‡§ß‡•ç‡§Ø‡§Ø‡§®":"A√çXXn","‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§Ø":"A√çXwX","‡§¶‡•ç‡§ò‡•ç‡§®":"√™√≤√≥","‡§¶‡•ç‡§ó‡•ç‡§ß":"√™√Æ`D",
  "‡§Æ‡§ß‡•ç‡§Ø‡§™‡•ç‡§∞‡§¶‡•á‡§∂":"m√çXpRdyS","‡§∏‡§æ‡§ß‡•ç‡§Ø":"sw√çX","‡§§‡•ç‡§µ":"√ãv",
  "‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø‡§§‡•ç‡§µ":"s<√°‚Ñ¢iq√ãv","‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§§‡•ç‡§µ":"√õXi√Ç√ãv","‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä‡§§‡•ç‡§µ":"√°ZI√ãv",
  "‡§™‡§µ‡§ø‡§§‡•ç‡§∞‡§§‡•ç‡§µ":"pivZ√ãv","‡§Ü‡§§‡•ç‡§Æ‡§§‡•ç‡§µ":"Aw√ãm√ãv",
  "‡§∂‡•ç‡§µ":"√úv","‡§∂‡•ç‡§µ‡§∏‡§®":"√úvsn","‡§∂‡•ç‡§µ‡§æ‡§∏":"√úvws","‡§∂‡•ç‡§µ‡•á‡§§":"√úvyq","‡§§‡§É":"q√ö",
  "‡§∂‡•ç‡§µ‡§æ‡§®":"√úvwn","‡§∂‡•ç‡§µ‡•á‡§ö‡•ç‡§õ‡§æ":"√úvy√áCw",
  "‡§Ö‡§π‡•ç‡§®‡§ø‡§ï‡§æ":"AiHnkw","‡§™‡•ç‡§∞‡§π‡•ç‡§£":"pRHx","‡§¶‡§π‡•ç‡§®‡§ø":"diHn","‡§π‡§ø‡§Æ‡§æ‡§≤‡§Ø":"ihmwlX",
  "‡§â‡§®‡•ç‡§Æ‡•á‡§∑":"aNmy‚Ä†","‡§â‡§®‡•ç‡§Æ‡§æ‡§¶":"aNmwd","‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ":"bRHm","‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ‡§æ":"bRHmw",
  "‡§∏‡•ç‡§§‡•ç‡§∞":"√°Z","‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä":"√°ZI","‡§∏‡•ç‡§§‡•ç‡§∞‡•ã‡§§":"√°Zoq","‡§∏‡•ç‡§§‡•ç‡§∞‡•à‡§£":"√°ZYx",
  "‡§∏‡•ç‡§§‡•ç‡§∞‡•à‡§£‡§§‡§æ":"√°ZYxqw","‡§∏‡•ç‡§§‡•ç‡§∞‡•ã‡§§‡§∏‡•ç‡§µ‡§∞":"√°Zoq√°vr",
  "‡§ö‡§Æ‡§§‡•ç‡§ï‡§æ‡§∞‡§ø‡§ï:":"cm√ãkwirk:","‡§ö‡§ø‡§®‡•ç‡§Æ‡§Ø":"icNmX","‡§Æ‡§®‡§®":"mnn",
  "‡§Ö‡§Æ‡•ç‡§®‡§æ‡§Ø":"AMnwX","‡§®‡§ø‡§Æ‡•ç‡§®":"inMn","‡§∏‡•ç‡§Æ‡§∞‡§£":"√°mrx",
  "‡§ß‡§æ‡§§‡•ç‡§µ‡§∞‡•ç‡§•":"Dw√ãvQ~","‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§®":"s<Xojn",
  "‡§¶‡•Å‡§ó‡•ç‡§ß‡§ó‡•ç‡§®":"du^D^n","‡§∞‡§æ‡§ó‡•ç‡§®‡•ç‡§Ø":"rw^NX","‡§Ö‡§ó‡•ç‡§®‡§ø‡§¶‡•á‡§µ":"Ai^ndyv","‡§Ö‡§ó‡•ç‡§®‡§ø‡§ï‡•Å‡§Ç‡§°":"Ai^nku<f",
  "‡§â‡§ï‡•ç‡§§":"a√Ç","‡§≠‡•Å‡§ï‡•ç‡§§":"Bu√Ç","‡§Ø‡•Å‡§ï‡•ç‡§§":"Xu√Ç","‡§¶‡•É‡§∑‡•ç‡§ü":"d√∑√†t","‡§≠‡§ï‡•ç‡§§‡§ø":"Bi√Ç",
  "‡§∏‡•ç‡§µ‡§∏‡•ç‡§§‡§ø‡§™‡•ç‡§∞‡§ú‡§æ‡§≠‡•ç‡§Ø‡§É":"√°vi√°qpRjw√íX√ö",
  "‡§™‡§∞‡§ø‡§™‡§æ‡§≤‡§Ø‡§®‡•ç‡§§‡§æ‡§Ç":"pirpwlXNqw<","‡§®‡•ç‡§Ø‡§æ‡§Ø‡•á‡§®":"NXwXyn","‡§Æ‡§æ‡§∞‡•ç‡§ó‡•á‡§£":"mwgy~x",
  "‡§ó‡•ã‡§¨‡•ç‡§∞‡§æ‡§π‡•ç‡§Æ‡§£‡•á‡§≠‡•ç‡§Ø‡§É":"gobRwHmxy√íX√ö","‡§∂‡•Å‡§≠‡§Æ‡§∏‡•ç‡§§‡•Å":"SuBm√°qu","‡§®‡§ø‡§§‡•ç‡§Ø‡§Ç":"in√ãX<",
  "‡§≤‡•ã‡§ï‡§æ‡§É":"lokw√ö","‡§∏‡§Æ‡§∏‡•ç‡§§‡§æ‡§É":"sm√°qw√ö","‡§∏‡•Å‡§ñ‡§ø‡§®‡•ã":"suiKno","‡§≠‡§µ‡§®‡•ç‡§§‡•Å":"BvNqu","‡§∞‡•ç‡§∏‡•ç‡§ï‡•ç‡§§‡•ç‡§∞‡§ø":"i√°√ÇR~","‡§∞‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡•ç‡§Ø‡§ø":"i√°k√µ√î~","‡§ï‡•ç‡§∑‡•ç‡§Æ":"√¢m","‡§∞‡•ç‡§≠‡•ç‡§∞‡•ç‡§Ø‡§ø":"iBR√î~","‡§∞‡•ç‡§Æ‡•ç‡§Ø‡•ç‡§∞‡§ø":"iMXR~","‡§∞‡•ç‡§£‡•ç‡§°‡•ç‡§∞‡§ø":"i&f√∂~","‡§∞‡•ç‡§∏‡•ç‡§§‡•ç‡§∞‡•ç‡§Æ‡§ø":"i√°√£m~","‡§∞‡•ç‡§∏‡•ç‡§ï‡•ç‡§≤‡•ç‡§Ø‡§ø":"i√°‚Ä∫√î~","‡§∞‡•ç‡§∏‡•ç‡§ï‡•ç‡§®‡•ç‡§∞‡§ø":"i√°#nR~","‡§∞‡•ç‡§∏‡•ç‡§§‡•ç‡§∞‡•ç‡§µ‡§ø":"i√°√£v~","‡§∞‡•ç‡§ï‡•ç‡§∞‡•ç‡§Ø‡§ø":"ik√µ√î~","‡§∞‡•ç‡§ï‡•ç‡§∑‡•ç‡§∞‡§ø":"i√¢r~","‡§∞‡•ç‡§∂‡•ç‡§ï‡•ç‡§∞‡§ø":"i√úk√µ~","‡§∞‡•ç‡§∂‡•ç‡§§‡•ç‡§∞‡§ø":"i√úZ~","‡§∞‡•ç‡§∏‡•ç‡§™‡•ç‡§∞‡§ø":"i√°pR~","‡§°‡•â‡§ï‡•ç‡§ü‡§∞":"f‡•â#tr","‡§∏‡•ç‡§∞":"sR","‡§ï‡•ç‡§≤":"‚Ä∫"
};

/* ============================================================
   PART 6 ‚Äì DERIVED HELPER SETS & CONSTANTS
============================================================ */
const WORD_KEYS = Object.keys(MAP_WORDS).sort((a,b)=>b.length - a.length);
const CONJ_KEYS = Object.keys(MAP_CONJ).sort((a,b)=>b.length - a.length);
const CONJ_KEYS_ZWJ = Object.keys(MAP_CONJ_ZWJ).sort((a,b)=>b.length - a.length);


const CONJ_VALUES = new Set(Object.values(MAP_CONJ));
const HALF_VALUES = new Set([
  ...Object.values(MAP_HALFA),
  ...Object.values(MAP_HALFB)
]);

const MAX_CONJ_LEN = Math.max(...Array.from(CONJ_VALUES, v => v.length));
const MAX_HALF_LEN = Math.max(...Array.from(HALF_VALUES, v => v.length));

const SIMPLE_CONS_CHARS = new Set([
  "k","K","g","G","|","c","C","j","J","\\",
  "t","T","f","F","x","q","Q","d","D","n",
  "p","P","b","B","m","X","r","l","v","S",
  "‚Ä†","s","h"
]);

function isDevaConsonant(ch) {
  return /[‡§ï-‡§π‡•ò-‡•ô‡•ö‡•õ‡•ú‡•ù‡•û‡•ü]/.test(ch);
}

// Look ahead from the halant to see if ANY consonant appears
// (ignoring ZWJ/ZWNJ and matras/signs)
function hasNextConsonantAfterHalant(text, halantIndex) {
  for (let j = halantIndex + 1; j < text.length; j++) {
    const ch = text[j];

    // ignore ZWJ/ZWNJ
    if (ch === "\u200c" || ch === "\u200d") continue;

    if (isDevaConsonant(ch)) return true;

    // if non-Devanagari, stop scan
    if (!/[\u0900-\u097F]/.test(ch)) return false;

    // matras/signs: continue scanning
  }
  return false;
}

/* ============================================================
   PART 7 ‚Äì i-SWAP (rules a, b, c)
============================================================ */
function swapI(text) {
  let arr = text.split("");

  for (let i = 0; i < arr.length; i++) {

    if (arr[i] !== "i") continue;

    let posC = i - 1;
    if (posC < 0) continue;

    // do not cross whitespace
    if (/\s/.test(arr[posC])) continue;

    let moved = false;

    // Rule (c): If just after conjunct ‚Üí move before conjunct
    for (let L = MAX_CONJ_LEN; L >= 1; L--) {
      const start = posC - L + 1;
      if (start < 0) continue;

      const cand = arr.slice(start, posC + 1).join("");
      if (CONJ_VALUES.has(cand)) {
        arr.splice(i, 1);
        arr.splice(start, 0, "i");
        i = start + 1;
        moved = true;
        break;
      }
    }
    if (moved) continue;

    // Now must be consonant or skip
    if (!SIMPLE_CONS_CHARS.has(arr[posC])) continue;

    // Rule (b): look for half block before consonant
    let clusterStart = posC;
    const halfEnd = posC - 1;

    if (halfEnd >= 0) {
      for (let L = MAX_HALF_LEN; L >= 1; L--) {
        const start = halfEnd - L + 1;
        if (start < 0) continue;

        const cand = arr.slice(start, halfEnd + 1).join("");
        if (HALF_VALUES.has(cand)) {
          clusterStart = start;
          break;
        }
      }
    }

    // Rule (a/b): move i before clusterStart
    arr.splice(i, 1);
    arr.splice(clusterStart, 0, "i");
    i = clusterStart + 1;
  }

  return arr.join("");
}

/* ============================================================
   PART 8 ‚Äì REPH FIX (r` ‚Üí ~ position) ‚Äî Now respects badi-ee "I"
============================================================ */

function fixReph(text) {
  let arr = text.split("");
  let i = 0;

  const HALF_CONS = new Set([
    "#","$","^","%","√ß","√á","C","√à","√â","√ä","√®","T`","√©","F",
    "&","√ã","√å","√ç","N","√é","√ú","√°","√†","√è","√ë","M","√í","√ò","√õ","r`"
  ]);

  const FULL_CONS = new Set([
    "K","g","G","|","c","C","j","J","\\","t","T","‡§°","f","F",
    "x","q","Q","d","D","n","p","P","b","B","m","X","r",
    "l","v","S","‚Ä†","s","h","√π"
  ]);

  const MATRA_AFTER = new Set(["<",">","w","I","u","U","y","Y","o","O","√∑"]);

  while (i < arr.length - 1) {

    if (arr[i] === "r" && arr[i + 1] === "`") {

      /* ---------- CLAUSE 1 (i + FULL + optional MATRA) ---------- */
      if (arr[i + 2] === "i" && FULL_CONS.has(arr[i + 3])) {

        // start scanning immediately after FULL consonant
        let scan = i + 4;
        let matraIdx = -1;

        if (scan < arr.length && MATRA_AFTER.has(arr[scan])) {
          matraIdx = scan;
        }

        // remove r`
        arr.splice(i, 2);

        if (matraIdx !== -1) {
          // adjust index after removal
          matraIdx -= 2;

          // insert AFTER matra
          arr.splice(matraIdx + 1, 0, "~");
        } else {
          // no matra ‚Üí after FULL consonant
          arr.splice(i + 1, 0, "~");
        }
        continue;
      }

      /* ---------- CLAUSE 3: HALF ‚Üí FULL ‚Üí MATRA ---------- */
      let halfIdx = i + 2;
      let fullIdx = halfIdx + 1;
      let matraIdx = fullIdx + 1;

      if (
        HALF_CONS.has(arr[halfIdx]) &&
        FULL_CONS.has(arr[fullIdx]) &&
        MATRA_AFTER.has(arr[matraIdx])
      ) {
        arr.splice(i, 2);
        matraIdx -= 2;
        arr.splice(matraIdx + 1, 0, "~");
        continue;
      }

      /* ---------- CLAUSE 2: FULL consonant ---------- */
      if (FULL_CONS.has(arr[i + 2])) {
        arr.splice(i, 2);
        arr.splice(i + 1, 0, "~");
        continue;
      }

      /* ---------- fallback ---------- */
      arr.splice(i, 2, "~");
      continue;
    }

    i++;
  }

  return arr.join("");
}



/* ============================================================
   PART 9 ‚Äì FULL UNICODE ‚Üí AMAR ENGINE WITH PRIORITY
   Priority:
   1. WORDS (MAP_WORDS)
   2. CONJUNCTS (MAP_CONJ)
   3. HALF A (if ANY consonant appears after halant)
   4. HALF B (if NO consonant after halant)
   5. LETTERS
   then apply swapI + fixReph
============================================================ */
function fullUnicodeToAmar(text) {
  let out = "";
  let i = 0;

  outerLoop:
  while (i < text.length) {

    // 1. WORD EXCEPTIONS
    for (const w of WORD_KEYS) {
      if (text.startsWith(w, i)) {
        out += MAP_WORDS[w];
        i += w.length;
        continue outerLoop;
      }
    }

    // 2. CONJUNCTS (normal)
    for (const cj of CONJ_KEYS) {
      if (text.startsWith(cj, i)) {
        out += MAP_CONJ[cj];
        i += cj.length;
        continue outerLoop;
      }
    }

    // 2b. CONJUNCTS with ZWJ (e.g. ‡§§‡•ç‚Äç‡§∞, ‡§∏‡•ç‚Äç‡§µ)
    for (const cj of CONJ_KEYS_ZWJ) {
      if (text.startsWith(cj, i)) {
        out += MAP_CONJ_ZWJ[cj];
        i += cj.length;
        continue outerLoop;
      }
    }

    const ch = text[i];
    const next = text[i+1];

    // Skip ZWJ/ZWNJ in output
    if (ch === "\u200c" || ch === "\u200d") {
      i++;
      continue;
    }


    // 3 & 4. HALF A / HALF B with "any consonant after halant" rule
    if (next === "‡•ç") {
      const halfKey = ch + "‡•ç";
      const hasCons = hasNextConsonantAfterHalant(text, i + 1);

      // If any consonant later ‚Üí prefer HALF A when present
      if (hasCons && MAP_HALFA[halfKey]) {
        out += MAP_HALFA[halfKey];
        i += 2;
        continue;
      }

      // If no consonant later ‚Üí prefer HALF B when present
      if (!hasCons && MAP_HALFB[halfKey]) {
        out += MAP_HALFB[halfKey];
        i += 2;
        continue;
      }

      // Fallbacks
      if (MAP_HALFA[halfKey]) {
        out += MAP_HALFA[halfKey];
        i += 2;
        continue;
      }
      if (MAP_HALFB[halfKey]) {
        out += MAP_HALFB[halfKey];
        i += 2;
        continue;
      }
    }

    // 5. SIMPLE LETTER
    if (MAP_LETTERS[ch] !== undefined) {
      out += MAP_LETTERS[ch];
    } else {
      out += ch;
    }

    i++;
  }

  // apply i-swap and reph after mapping
  out = swapI(out);
  out = fixReph(out);
  return out;
}




/* ============================================================
   PART 10 ‚Äì AMAR ‚Üí UNICODE REVERSE (best-effort)
============================================================ */
let MASTER_MAP = {};
for (const k in MAP_LETTERS) MASTER_MAP[k] = MAP_LETTERS[k];
for (const k in MAP_HALFB)   MASTER_MAP[k] = MAP_HALFB[k];
for (const k in MAP_HALFA)   MASTER_MAP[k] = MAP_HALFA[k];
for (const k in MAP_CONJ)    MASTER_MAP[k] = MAP_CONJ[k];
for (const k in MAP_WORDS)   MASTER_MAP[k] = MAP_WORDS[k];

let REVERSE_MAP = {};
for (const k in MASTER_MAP) {
  const v = MASTER_MAP[k];
  if (!REVERSE_MAP[v]) REVERSE_MAP[v] = k;
}
const REVERSE_KEYS = Object.keys(REVERSE_MAP).sort((a,b)=>b.length - a.length);

function amarToUnicode(text) {
  let out = "";
  let i = 0;
  while (i < text.length) {
    let matched = false;
    for (const key of REVERSE_KEYS) {
      if (text.startsWith(key, i)) {
        out += REVERSE_MAP[key];
        i += key.length;
        matched = true;
        break;
      }
    }
    if (!matched) {
      out += text[i];
      i++;
    }
  }
  return out;
}




/* ============================================================
   LANGUAGE DETECTION (SAFE, STRICT)
============================================================ */

function detectInputLanguage(text) {
  if (!text || !text.trim()) return null;

  // Take a reasonable sample
  const sample = text.slice(0, 200);

  let hasDeva = false;
  let hasLatin = false;

  for (const ch of sample) {
    const code = ch.charCodeAt(0);

    // Hindi / Devanagari
    if (code >= 0x0900 && code <= 0x097F) {
      hasDeva = true;
      continue;
    }

    // English letters
    if (
      (code >= 65 && code <= 90) ||     // A‚ÄìZ
      (code >= 97 && code <= 122)       // a‚Äìz
    ) {
      hasLatin = true;
      continue;
    }

    // Digits
    if (code >= 48 && code <= 57) continue;

    // Whitespace
    if (/\s/.test(ch)) continue;

    // Common punctuation / smart punctuation
    if (
      ".,!?;:'\"()[]{}<>-‚Äì‚Äî_+/\\|@#$%^&*=`~‚Çπ‚Ä¢‚Ä¶".includes(ch)
    ) {
      continue;
    }

    // üö´ Any other script ‚Üí unsupported
    return "unsupported";
  }

  // Priority: Hindi first
  if (hasDeva) return "hindi";
  if (hasLatin) return "english";

  return "unsupported";
}



/* ============================================================
   OUTPUT MODE CONTROLLER (AUTO UI) ‚Äî FINAL
============================================================ */
function updateOutputModes(inputText){

  const select = document.getElementById("outputMode");
  if (!select) return;

  select.innerHTML = "";

  const lang = detectInputLanguage(inputText);

  if (lang === "unsupported" || !lang) {
    return;
  }

  const OPTIONS = {
    hindi: [
      { value: "h2a", label: "Hindi ‚Üí Amar Hindi" },
      { value: "h2e", label: "Hindi ‚Üí English" }
    ],
    english: [
      { value: "e2h", label: "English ‚Üí Hindi" },
      { value: "e2a", label: "English ‚Üí Amar Hindi" }
    ]
  };

  OPTIONS[lang].forEach(opt => {
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    select.appendChild(o);
  });

  // ‚úÖ default selection + font
  select.value = OPTIONS[lang][0].value;
  applyOutputFont(select.value);
}





/* ============================================================
   INITIALIZE OUTPUT MODES ON LOAD (‚¨ÖÔ∏è ADD THIS HERE)
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("unicodeInput");
  if (input) {
    syncOutputUI();
  }
});






function mapLangCode(lang) {
  switch (lang) {
    case "english": return "en";
    case "hindi": return "hi";
    default: return lang;
  }
}



/* =========================================================
   TRANSLATION CACHE (SESSION + MEMORY)
========================================================= */

const translationCache = new Map();

function getTranslationCacheKey(from, to, text) {
  // normalize text slightly to avoid duplicate keys
  return `${from}|${to}|${text.trim()}`;
}



/* ============================================================
   TRANSLATION ENGINE ‚Äî MICROSOFT TRANSLATOR (RAPIDAPI)
============================================================ */



async function translateText({ text, from, to }) {
  if (!text || !text.trim()) return text;

  const LANG_MAP = {
    english: "en",
    hindi: "hi"
  };

  const cacheKey = getTranslationCacheKey(from, to, text);

  if (translationCache.has(cacheKey)) {
    return translationCache.get(cacheKey);
  }

  const sessionHit = sessionStorage.getItem(cacheKey);
  if (sessionHit) {
    translationCache.set(cacheKey, sessionHit);
    return sessionHit;
  }

  try {
    const url =
      "https://api.mymemory.translated.net/get" +
      "?q=" + encodeURIComponent(text) +
      "&langpair=" + LANG_MAP[from] + "|" + LANG_MAP[to];

    const response = await fetch(url);
    if (!response.ok) throw new Error("Service unavailable");

    const data = await response.json();
    const translated = data?.responseData?.translatedText?.trim();

    if (!translated) throw new Error("Empty translation");

    translationCache.set(cacheKey, translated);
    sessionStorage.setItem(cacheKey, translated);
    return translated;

  } catch (err) {
    console.warn("Translation busy:", err);
    throw new Error(
      "Translation service is busy. Please retry in a moment."
    );
  }
}



/* ============================================================
   STEP 4C ‚Äî HINDI NORMALIZATION
============================================================ */

function normalizeHindi(text) {
  return text.normalize("NFC");
}





async function processDocxNode({
  text,
  inputLang,
  outputMode
}) {
  // Skip empty / symbols-only text
  if (!/[A-Za-z\u0900-\u097F]/.test(text)) return text;

  try {
    switch (outputMode) {

      case "h2e":
        return await translateText({
          text,
          from: "hindi",
          to: "english"
        });

      case "e2h":
        return normalizeHindi(
          await translateText({
            text,
            from: "english",
            to: "hindi"
          })
        );

      case "e2a": {
        const hindi = await translateText({
          text,
          from: "english",
          to: "hindi"
        });
        return fullUnicodeToAmar(normalizeHindi(hindi));
      }

      case "h2a":
        return fullUnicodeToAmar(normalizeHindi(text));

      default:
        return text;
    }

  } catch (err) {
    console.warn("DOCX translation busy:", err);

    // üîπ Soft fail: keep original text
    return text;
  }
}




function applyOutputFont(outputMode) {
  const box = document.getElementById("amarOutput");
  if (!box) return;

  box.classList.remove("font-amar", "font-hindi", "font-english");

  switch (outputMode) {
    case "h2a":
    case "e2a":
      box.classList.add("font-amar");
      break;

    case "h2e":
      box.classList.add("font-english");
      break;

    case "e2h":
      box.classList.add("font-hindi");
      break;

    default:
      box.classList.add("font-english");
  }
}

/* ============================================================
   TEXTBOX UI SYNC ‚Äî FINAL STABLE VERSION
============================================================ */
function syncOutputUI() {
  const input = document.getElementById("unicodeInput");
  const select = document.getElementById("outputMode");
  const btn = document.querySelector("button[onclick='handleUnicodeToAmar()']");
  const warn = document.getElementById("langWarn");

  if (!input || !select || !btn || !warn) return;

  const text = input.value.trim();

  // Reset UI
  warn.style.display = "none";
  warn.innerText = "";
  select.innerHTML = "";
  btn.disabled = true;
  btn.style.opacity = "0.6";

  if (!text) return;

  const lang = detectInputLanguage(text);

  // üö´ Unsupported language
  if (lang === "unsupported") {
    warn.innerText =
      "‚ö†Ô∏è Only English and Regular Hindi are supported at the moment.";
    warn.style.display = "block";
    return;
  }

  // ‚úÖ Valid input ‚Üí enable UI
  btn.disabled = false;
  btn.style.opacity = "1";

  updateOutputModes(text);
}





/* ============================================================
   PART 11 ‚Äì UI HANDLERS

============================================================ */

document.getElementById("unicodeInput")
  .addEventListener("input", syncOutputUI);

document.getElementById("unicodeInput")
  .addEventListener("paste", () => {
    setTimeout(syncOutputUI, 0);
  });





async function handleUnicodeToAmar() {

  const inputBox = document.getElementById("unicodeInput");
  const outputBox = document.getElementById("amarOutput");
  const modeSelect = document.getElementById("outputMode");

  if (!inputBox || !outputBox || !modeSelect) {
    alert("Conversion UI not initialized correctly.");
    return;
  }

  // ‚úÖ FIX-2: Normalize + count characters FIRST
  const rawInput = inputBox.value || "";
  const charsToConvert = countChars(rawInput);

  if (charsToConvert === 0) {
    alert("Please enter valid text to convert.");
    return;
  }

  // üîí Check plan + limits ONLY after valid char count
  const allowed = await canProceed("conversion");
  if (!allowed) return;

  const input = rawInput.trim();
  const detectedLang = detectInputLanguage(input);

  if (detectedLang === "unsupported") {
    alert(
      "Unsupported language detected.\n\n" +
      "Only English and Regular Hindi are supported."
    );
    return;
  }

  const outputMode = modeSelect.value;
  let output = "";

  try {
    switch (outputMode) {

      case "h2a":
        output = fullUnicodeToAmar(normalizeHindi(input));
        break;

      case "h2e":
        output = await translateText({
          text: input,
          from: "hindi",
          to: "english"
        });
        break;

      case "e2h":
        output = normalizeHindi(
          await translateText({
            text: input,
            from: "english",
            to: "hindi"
          })
        );
        break;

      case "e2a": {
        const hindi = await translateText({
          text: input,
          from: "english",
          to: "hindi"
        });
        output = fullUnicodeToAmar(normalizeHindi(hindi));
        break;
      }

      default:
        alert("Invalid output mode selected.");
        return;
    }

  } catch (err) {
    console.error("Conversion error:", err);
    alert(
      err.message ||
      "Conversion failed. Please try again in a moment."
    );
    return;
  }

  // ‚úÖ Set output + font
  outputBox.value = output;
  applyOutputFont(outputMode);

  // ‚úÖ Record correct usage (NO mismatch now)
  const uid = auth.currentUser.uid;
  const ref = db.collection("users").doc(uid);

const internal = await isInternalUser(uid);
if (!internal) {
  await ref.update({
    "usage.conversionsToday":
      firebase.firestore.FieldValue.increment(1),
    "usage.charsToday":
      firebase.firestore.FieldValue.increment(charsToConvert)
  });
}




  // üîÑ Refresh UI
  await loadCurrentUser(uid);
  renderUsageBar();
}




function handleAmarToUnicode() {
  const a = document.getElementById("amarOutput").value;
  const u = amarToUnicode(a);
  document.getElementById("unicodeInput").value = u;
}

function copyAmar() {
  const box = document.getElementById("amarOutput");
  box.select();
  document.execCommand("copy");
}

/* ============================================================
   PART 12 ‚Äì DOCX: Unicode ‚Üí Amar (keep structure)
============================================================ */
function xmlEscape(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&apos;");
}





function countCharsFromDocxXml(xmlDoc){
  const W_NS = "http://schemas.openxmlformats.org/wordprocessingml/2006/main";
  let textNodes = xmlDoc.getElementsByTagNameNS(W_NS, "t");

  if(!textNodes || !textNodes.length){
    textNodes = xmlDoc.getElementsByTagName("w:t");
  }

  let total = 0;
  for(let i = 0; i < textNodes.length; i++){
    total += (textNodes[i].textContent || "").length;
  }
  return total;
}


// DOCX converter using XML DOM (keeps formatting, solves corruption issues)


async function analyzeDocxLanguage(file) {
  const arrayBuffer = await file.arrayBuffer();
  const zip = await JSZip.loadAsync(arrayBuffer);
  const docFile = zip.file("word/document.xml");
  if (!docFile) throw new Error("Invalid DOCX file");

  const xmlString = await docFile.async("string");
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(xmlString, "application/xml");

  const W_NS = "http://schemas.openxmlformats.org/wordprocessingml/2006/main";
  let textNodes = xmlDoc.getElementsByTagNameNS(W_NS, "t");
  if (!textNodes.length) textNodes = xmlDoc.getElementsByTagName("w:t");

  let sample = "";

  for (let i = 0; i < textNodes.length && sample.length < 300; i++) {
    const txt = (textNodes[i].textContent || "").trim();

    // üîí Ignore symbol-only / numeric-only runs
    if (!/[A-Za-z\u0900-\u097F]/.test(txt)) continue;

    sample += txt;
  }

  if (!sample) return "unsupported";

  return detectInputLanguage(sample);
}




/* ============================================================
   STEP D ‚Äî DOCX FILE CHANGE HANDLER
============================================================ */
document.getElementById("docxFile")
  .addEventListener("change", async (e) => {

  const file = e.target.files[0];
  if (!file) return;

  const box = document.getElementById("docxLangBox");
  const langSpan = document.getElementById("docxDetectedLang");
  const select = document.getElementById("docxOutputMode");
  const btn = document.getElementById("docxConvertBtn");

  // Reset UI
  box.style.display = "none";
  select.innerHTML = "";
  btn.disabled = true;
  btn.style.opacity = "0.6";
  btn.style.cursor = "not-allowed";

  try {
    const detectedLang = await analyzeDocxLanguage(file);

    // üö´ Unsupported language
    if (detectedLang === "unsupported") {
      alert(
        "Unsupported language detected in the uploaded file.\n\n" +
        "Only English and Regular Hindi DOCX files are supported."
      );
      return;
    }

    // Show detected language
    langSpan.innerText =
      detectedLang === "hindi"
        ? "Hindi (Unicode)"
        : "English";

    langSpan.dataset.lang = detectedLang;

    const OPTIONS = {
      hindi: [
        { value: "h2a", label: "Hindi ‚Üí Amar Hindi" },
        { value: "h2e", label: "Hindi ‚Üí English" }
      ],
      english: [
        { value: "e2h", label: "English ‚Üí Hindi" },
        { value: "e2a", label: "English ‚Üí Amar Hindi" }
      ]
    };

    OPTIONS[detectedLang].forEach(opt => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.label;
      select.appendChild(o);
    });

    select.value = OPTIONS[detectedLang][0].value;

    // Enable UI
    box.style.display = "block";
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";

  } catch (err) {
    console.error(err);
    alert(
      "Unable to read this DOCX file.\n\n" +
      "The file may be corrupted or protected."
    );
  }
});


async function convertDocx(){

  // üîí PLAN CHECK FIRST (prevents partial DOCX writes)
  const allowed = await canProceed("docx");
  if (!allowed) return;


  const fileInput = document.getElementById("docxFile");
  if (!fileInput || !fileInput.files.length) {
    alert("Please choose a DOCX file.");
    return;
  }

  const file = fileInput.files[0];

  try {
    /* ===============================
       1Ô∏è‚É£ READ DOCX
    =============================== */
    const arrayBuffer = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);

    const docFile = zip.file("word/document.xml");
    if (!docFile) {
      alert("Invalid DOCX file.");
      return;
    }

    const xmlString = await docFile.async("string");
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlString, "application/xml");

    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
      alert("Error reading DOCX content.");
      return;
    }

    /* ===============================
       2Ô∏è‚É£ COLLECT TEXT NODES
    =============================== */
    const W_NS = "http://schemas.openxmlformats.org/wordprocessingml/2006/main";
    let textNodes = xmlDoc.getElementsByTagNameNS(W_NS, "t");

    if (!textNodes || !textNodes.length) {
      textNodes = xmlDoc.getElementsByTagName("w:t");
    }

    /* ===============================
       3Ô∏è‚É£ LANGUAGE DETECTION (ONCE)
    =============================== */
/* ===============================
   3Ô∏è‚É£ LANGUAGE DETECTION (DOCX SAFE)
   (already done on file upload)
=============================== */
const detectedLang =
  document.getElementById("docxDetectedLang")?.dataset?.lang;

if (!detectedLang) {
  alert("Unable to detect DOCX language. Please re-upload the file.");
  return;
}





// üîÅ NEW: sync dropdown exactly like textbox


    if (detectedLang === "unsupported") {
      alert(
        "Language not supported in DOCX.\n\n" +
        "This converter supports only:\n" +
        "‚Ä¢ Regular Hindi (Unicode)\n" +
        "‚Ä¢ English (Roman)"
      );
      return;
    }

    /* ===============================
       4Ô∏è‚É£ CHARACTER COUNT + PLAN CHECK
    =============================== */
    const charCount = countCharsFromDocxXml(xmlDoc);
 


    /* ===============================
       5Ô∏è‚É£ DETERMINE OUTPUT MODE
       (DEFAULT = Hindi ‚Üí Amar)
    =============================== */
    const modeEl = document.getElementById("outputMode");
    const outputMode =
  document.getElementById("docxOutputMode")?.value || "h2a";


    /* ===============================
       6Ô∏è‚É£ PROCESS EACH TEXT NODE
    =============================== */
    for (let i = 0; i < textNodes.length; i++) {
      const node = textNodes[i];
      const original = node.textContent || "";

     // Skip symbols-only or numeric-only runs
if (!/[A-Za-z\u0900-\u097F]/.test(original)) continue;

      const converted = await processDocxNode({
        text: original,
        inputLang: detectedLang,
        outputMode
      });

      node.textContent = "";
node.appendChild(
  xmlDoc.createTextNode(converted)
);

    }

    /* ===============================
       7Ô∏è‚É£ SAVE BACK TO DOCX
    =============================== */
    const serializer = new XMLSerializer();
    const newXmlString = serializer.serializeToString(xmlDoc);
    zip.file("word/document.xml", newXmlString);

    const outBlob = await zip.generateAsync({
      type: "blob",
      mimeType:
        "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    });

    const ts = new Date()
      .toISOString()
      .replace(/[^\d]/g, "")
      .slice(0, 14);

    const outName =
      file.name.replace(/\.docx$/i, "") + "_converted_" + ts + ".docx";

    saveAs(outBlob, outName);

    /* ===============================
       8Ô∏è‚É£ UPDATE USAGE
    =============================== */
    const uid = auth.currentUser.uid;
    const ref = db.collection("users").doc(uid);

const internal = await isInternalUser(uid);
if (!internal) {
  await ref.update({
    "usage.docxToday":
      firebase.firestore.FieldValue.increment(1),
    "usage.charsToday":
      firebase.firestore.FieldValue.increment(charCount)
  });
}


    await loadCurrentUser(uid);
    renderUsageBar();

    alert("DOCX converted successfully.");

  } catch (err) {
    console.error("DOCX conversion error:", err);
    alert(
  "DOCX conversion could not be completed.\n\n" +
  "Possible reasons:\n" +
  "‚Ä¢ Translation service is busy\n" +
  "‚Ä¢ Unsupported language in file\n" +
  "‚Ä¢ Protected or complex formatting\n\n" +
  "Please try again after a moment."
);

  }
}


</script>



</div>

<!-- ================= FOOTER ================= -->
<div id="kgFooter">
  Copyright ¬© 2025 KG & NB.
</div>

<style>
#kgFooter{
  position:fixed;
  bottom:10px;
  right:10px;
  font-size:11px;
  color:#666;
  background:rgba(255,255,255,0.7);
  padding:4px 8px;
  border-radius:4px;
}
</style>

<!-- ================= AUTH + CAPTCHA + SESSION SCRIPT ================= -->
<script>
/* ================= FIREBASE CONFIG ================= */
/* üî¥ UPDATE THESE 3 VALUES ONLY */
firebase.initializeApp({
  apiKey: "AIzaSyA50_nDcVr1PllKi9aff6Awo4w7XQAs3qc",
  authDomain: "amarfont-converter.firebaseapp.com",
  projectId: "amarfont-converter"
});



const auth = firebase.auth();
const db = firebase.firestore();   // ‚úÖ ADD THIS LINE ONLY

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

/* ================= STATE ================= */
let captchaValue="", isSignup=false, captchaFails=0;


/* ================= DOM REFERENCES ================= */
const acceptTnc = document.getElementById("acceptTnc");

const submitBtn = document.getElementById("submitBtn");
const captchaInput = document.getElementById("captchaInput");
const formTitle = document.getElementById("formTitle");
const switchBtn = document.getElementById("switchBtn");
const confirmWrap = document.getElementById("confirmWrap");
const tncWrap = document.getElementById("tncWrap");
const verifyMsg = document.getElementById("verifyMsg");
const email = document.getElementById("email");
const password = document.getElementById("password");
const confirmPassword = document.getElementById("confirmPassword");






/* =====================================================
   STEP 2.2 ‚Äî ENSURE + DAILY RESET USER USAGE
===================================================== */

/* =====================================================
   üîπ GLOBAL USER CACHE
===================================================== */
let currentUser = null;
let currentUserData = null;

/* =====================================================
   üîπ LOAD CURRENT USER DATA (ADD ONCE)
===================================================== */
async function loadCurrentUser(uid){
  const snap = await db.collection("users").doc(uid).get();
  currentUserData = snap.data();
}

async function renderPlanBar() {
  if (!currentUserData || !currentUser) return;

  const planNameEl = document.getElementById("planName");
  const planMetaEl = document.getElementById("planMeta");
  const upgradeBtn = document.getElementById("upgradeBtn");
  const badgeEl = document.getElementById("currentPlanBadge");

  if (!planNameEl || !planMetaEl) return;

  // üîì INTERNAL ADMIN OVERRIDE (UI ONLY)
  try {
    const internal = currentUserData?._isInternal === true;
    if (internal) {
      planNameEl.innerText = "Admin";
      planMetaEl.innerText = "(Unlimited access ‚Äì Internal user)";

      if (upgradeBtn) upgradeBtn.style.display = "none";
      if (badgeEl) badgeEl.innerText = "Admin";

      return;
    }
  } catch (e) {
    console.error("Admin check failed in plan bar", e);
  }

  // -------------------------------
  // NORMAL USER FLOW
  // -------------------------------
  const plan = currentUserData.plan || "free";

  const PLAN_BAR_TEXT = {
    free:    "Per Day Limit : 500 chars ¬∑ 2 text-box conversions ¬∑ 0 Ms-Word- *.Docx file Upload Conversion",
    basic:   "Per Day Limit : 1,000 chars ¬∑ 10 text-box conversions ¬∑ 2 Ms-Word- *.Docx file Upload Conversion",
    premium: "Per Day Limit : UNLIMITED USAGE !!"
  };

  planNameEl.innerText =
    plan.charAt(0).toUpperCase() + plan.slice(1);

  planMetaEl.innerText =
    `(${PLAN_BAR_TEXT[plan] || PLAN_BAR_TEXT.free})`;

  if (badgeEl) {
    badgeEl.innerText =
      plan.charAt(0).toUpperCase() + plan.slice(1);
  }

  if (upgradeBtn) {
    upgradeBtn.style.display = "inline-block";
  }
}




function renderUsageBar() {
  if (!currentUserData || !currentUserData.usage) return;

  const fill = document.getElementById("charFill");
  const text = document.getElementById("charText");
  const warn = document.getElementById("charWarn");

  if (!fill || !text || !warn) return;

  // üîì INTERNAL ADMIN ‚Üí UNLIMITED
  if (currentUserData._isInternal === true) {
    fill.style.width = "100%";
    fill.style.background = "#2ecc71";
    text.innerText = "Unlimited";
    warn.style.display = "none";
    return;
  }

  const used = Number(currentUserData.usage.charsToday || 0);
  const plan = currentUserData.plan || "free";
  const limit =
    PLAN_LIMITS[plan]?.charsPerDay ?? PLAN_LIMITS.free.charsPerDay;

  if (limit === Infinity) {
    fill.style.width = "100%";
    fill.style.background = "#2ecc71";
    text.innerText = "Unlimited";
    warn.style.display = "none";
    return;
  }

  const percent = Math.min(100, Math.round((used / limit) * 100));
  fill.style.width = percent + "%";
  fill.style.background = percent >= 90 ? "#e74c3c" : "#4caf50";
  text.innerText = `${used} / ${limit}`;
  warn.style.display = percent >= 90 ? "block" : "none";
}






/* =====================================================
   STEP 2.1 + 2.2 ‚Äî ENSURE USER USAGE + DAILY RESET
===================================================== */
async function ensureUserUsage(uid, email){
  const ref = db.collection("users").doc(uid);
  const snap = await ref.get();

  const now = firebase.firestore.Timestamp.now();
  const todayKey = new Date().toDateString(); // calendar day key

  /* ---------------- FIRST TIME USER ---------------- */
  if(!snap.exists){
    await ref.set({
      email,
      plan: "free",
      planExpiry: null,
      usage: {
        conversionsToday: 0,
        docxToday: 0,
        charsToday: 0,
        lastReset: now,
        lastResetKey: todayKey
      },
      createdAt: now
    });

    currentUserData = {
      email,
      plan: "free",
      planExpiry: null,
      usage: {
        conversionsToday: 0,
        docxToday: 0,
        charsToday: 0,
        lastReset: now,
        lastResetKey: todayKey
      }
    };
    return;
  }

  /* ---------------- EXISTING USER ---------------- */
  const data = snap.data();
  const updates = {};

  // üõ° Plan safety
  if(!data.plan) updates.plan = "free";
  if(data.planExpiry === undefined) updates.planExpiry = null;

  // üõ° Usage safety
  if(!data.usage){
    updates.usage = {
      conversionsToday: 0,
      docxToday: 0,
      charsToday: 0,
      lastReset: now,
      lastResetKey: todayKey
    };
  } else {

    // üîÅ DAILY RESET (SAFE + IDENTITY BASED)
    if(data.usage.lastResetKey !== todayKey){
      updates["usage.conversionsToday"] = 0;
      updates["usage.docxToday"] = 0;
      updates["usage.charsToday"] = 0;
      updates["usage.lastReset"] = now;
      updates["usage.lastResetKey"] = todayKey;
    }

    // Backfill missing fields (no overwrite)
    if(data.usage.conversionsToday === undefined)
      updates["usage.conversionsToday"] = 0;

    if(data.usage.docxToday === undefined)
      updates["usage.docxToday"] = 0;

    if(data.usage.charsToday === undefined)
      updates["usage.charsToday"] = 0;

    if(!data.usage.lastReset)
      updates["usage.lastReset"] = now;

    if(!data.usage.lastResetKey)
      updates["usage.lastResetKey"] = todayKey;
  }

  if(Object.keys(updates).length){
    await ref.update(updates);
  }

  // üîÑ Refresh local cache
await loadCurrentUser(uid);
await renderPlanBar();
renderUsageBar();

}







/* =====================================================
   STEP 2.2 ‚Äî RECORD USAGE
===================================================== */
async function recordUsage(type, chars = 0){
  const uid = auth.currentUser.uid;
  const ref = db.collection("users").doc(uid);

  const updates = {};

  if(type === "conversion"){
    updates["usage.conversionsToday"] =
      firebase.firestore.FieldValue.increment(1);
  }

  if(type === "docx"){
    updates["usage.docxToday"] =
      firebase.firestore.FieldValue.increment(1);
  }

  if(chars > 0){
    updates["usage.charsToday"] =
      firebase.firestore.FieldValue.increment(chars);
  }

  const internal = currentUserData?._isInternal === true;
if (internal) return;

await ref.update(updates);


  await loadCurrentUser(uid);
  renderUsageBar();
}




/* ================= PLAN LIMITS ================= */
const PLAN_LIMITS = {
  free: {
    charsPerDay: 500,
    conversionsPerDay: 2,
    docxPerDay: 0
  },
  basic: {
    charsPerDay: 1000,
    conversionsPerDay: 10,
    docxPerDay: 2
  },
  premium: {
    charsPerDay: Infinity,
    conversionsPerDay: Infinity,
    docxPerDay: Infinity
  }
};






async function checkCharLimit(incomingChars){
  const user = auth.currentUser;
  if (!user) return false;

  // üîì INTERNAL ADMIN BYPASS
  try {
    const internal = await isInternalUser(user.uid);
    if (internal) return true;
  } catch (e) {
    console.error("Internal check failed in checkCharLimit", e);
  }

  const snap = await db.collection("users").doc(user.uid).get();
  if (!snap.exists) return false;

  const data = snap.data();

  // üíé Paid plans = unlimited
  if (data.plan && data.plan !== "free") return true;

  const used = Number(data.usage?.charsToday || 0);
  const limit = PLAN_LIMITS.free.charsPerDay;

  // üö´ BLOCK (FREE PLAN ONLY)
  if (used + incomingChars > limit) {
    alert(
      `Daily character limit exceeded.\n\n` +
      `Free plan limit: ${limit} characters/day\n` +
      `Used today: ${used}\n` +
      `Trying to convert: ${incomingChars}\n\n` +
      `Please try tomorrow or upgrade your plan.`
    );
    return false;
  }

  return true;
}




async function isInternalUser(uid) {
  try {
    const snap = await db.collection("internal_users").doc(uid).get();
    return snap.exists && snap.data()?.unlimited === true;
  } catch (e) {
    console.error("Internal user check failed", e);
    return false;
  }
}




/* =====================================================
   STEP 2.3 ‚Äî CHECK USAGE LIMIT
===================================================== */
async function canProceed(actionType) {
  const user = auth.currentUser;
  if (!user) return false;

  // üîì INTERNAL USER BYPASS (HIGHEST PRIORITY)
  const internal = await isInternalUser(user.uid);
  if (internal) {
    console.log("Internal admin ‚Äì unlimited access");
    return true;
  }

  // -------------------------------
  // NORMAL USER FLOW BELOW
  // -------------------------------
  const snap = await db.collection("users").doc(user.uid).get();
  if (!snap.exists) return false;

  const data = snap.data();
  const usage = data.usage || {};
  const plan = data.plan || "free";
  const limits = PLAN_LIMITS[plan] || PLAN_LIMITS.free;

  // Paid users = unlimited
  if (plan !== "free") return true;

  // ----- CONVERSION CHECK -----
  if (actionType === "conversion") {
    const text = document.getElementById("unicodeInput")?.value || "";
    const charsToConvert = countChars(text);

    if (charsToConvert === 0) {
      alert("Please enter text to convert.");
      return false;
    }

    if ((usage.charsToday || 0) + charsToConvert > limits.charsPerDay) {
      alert(
        `Daily character limit reached.\n\n` +
        `Free plan allows ${limits.charsPerDay} characters per day.\n` +
        `You have already used ${usage.charsToday || 0}.`
      );
      return false;
    }
  }

  // ----- DOCX CHECK -----
  if (actionType === "docx") {
    if ((usage.docxToday || 0) >= limits.docxPerDay) {
      alert(
        `Daily DOCX limit reached.\n\n` +
        `Free plan allows ${limits.docxPerDay} DOCX per day.`
      );
      return false;
    }
  }

  return true;
}





function countChars(text){
  if (!text) return 0;

  // normalize Word junk
  const clean = text
    .replace(/\u00A0/g, " ")   // nbsp
    .replace(/\u200B/g, "")    // zero-width
    .replace(/\s+/g, " ")
    .trim();

  return clean.length;
}





/* ================= AUTH STATE ================= */

auth.onAuthStateChanged(async user => {
  if (user && user.emailVerified) {
    currentUser = user;

    // üîí Ensure schema + daily reset
    await ensureUserUsage(user.uid, user.email);

   

// üîì Cache admin flag ONCE
currentUserData._isInternal = await isInternalUser(user.uid);

await renderPlanBar();
renderUsageBar();


    document.getElementById("authScreen").style.display = "none";
    document.getElementById("engine").style.display = "block";
  } else {
    currentUser = null;
    currentUserData = null;

    document.getElementById("authScreen").style.display = "flex";
    document.getElementById("engine").style.display = "none";

    refreshCaptcha();
  }
});


/* ================= LOGIN ATTEMPT SECURITY ================= */
const MAX_LOGIN_ATTEMPTS = 5;
const LOCK_TIME_MS = 15 * 60 * 1000; // 15 minutes

function getLoginState(){
  return JSON.parse(sessionStorage.getItem("loginSec") || "{}");
}

function setLoginState(state){
  sessionStorage.setItem("loginSec", JSON.stringify(state));
}

function isLoginLocked(){
  const s = getLoginState();
  if(!s.lockUntil) return false;
  if(Date.now() > s.lockUntil){
    sessionStorage.removeItem("loginSec");
    return false;
  }
  return true;
}

function recordLoginFailure(){
  const s = getLoginState();
  s.failCount = (s.failCount || 0) + 1;

  if(s.failCount >= MAX_LOGIN_ATTEMPTS){
    s.lockUntil = Date.now() + LOCK_TIME_MS;
  }

  setLoginState(s);
}

function resetLoginFailures(){
  sessionStorage.removeItem("loginSec");
}



/* ================= LOGOUT ================= */
function logout(){
  if(!confirm("Are you sure you want to logout?")) return;

  auth.signOut().then(()=>{
    captchaFails = 0;        // reset security state
    submitBtn.disabled = false;
    submitBtn.style.opacity = "1";
    captchaInput.value = "";
    refreshCaptcha();
    alert("Logged out successfully");
  });
}



/* ================= CAPTCHA ================= */
let lastRefresh = 0;

function drawCaptcha(){
  const c=document.getElementById("captchaCanvas"),x=c.getContext("2d");
  c.width=300;c.height=50;
  x.fillStyle="#fff";x.fillRect(0,0,300,50);
  captchaValue="";
  const ch="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  for(let i=0;i<6;i++) captchaValue+=ch[Math.floor(Math.random()*ch.length)];
  for(let i=0;i<40;i++){
    x.fillStyle=`rgba(0,0,0,${Math.random()})`;
    x.fillRect(Math.random()*300,Math.random()*50,2,2);
  }
  x.textAlign="center";x.textBaseline="middle";
  [...captchaValue].forEach((c,i)=>{
    x.save();
    x.translate(40+i*40,25);
    x.rotate((Math.random()-.5)*.5);
    x.font=`${22+Math.random()*6}px Arial`;
    x.fillStyle="#1e3c72";
    x.fillText(c,0,0);
    x.restore();
  });
}

function refreshCaptcha(){
  if(Date.now() - lastRefresh < 1000) return;
  lastRefresh = Date.now();
  captchaInput.value = "";   // optional
  drawCaptcha();
}



/* ================= UI ================= */
function togglePwd(id){const e=document.getElementById(id);e.type=e.type==="password"?"text":"password";}

function showMsg(t){
  document.getElementById("msg").innerText = t;
}


function switchMode(){

  submitBtn.disabled = false;
  submitBtn.style.opacity = "1";
  captchaFails = 0;

  isSignup = !isSignup;   // ‚úÖ ADD THIS LINE

  formTitle.innerText=isSignup?"Create Account":"Login";
  submitBtn.innerText=isSignup?"Sign Up":"Login";
  switchBtn.innerText=isSignup?"Back to Login":"Create Account";
  confirmWrap.style.display=isSignup?"block":"none";
  tncWrap.style.display=isSignup?"block":"none";
  verifyMsg.style.display="none";
  showMsg(""); refreshCaptcha();
}


/* ================= SUBMIT (SECURITY HARDENED) ================= */
function submitForm(){

  /* ---------- CAPTCHA CHECK ---------- */
  if(captchaInput.value.trim().toUpperCase() !== captchaValue){
    captchaFails++;

    // üîí Lock after 3 CAPTCHA failures
    if(captchaFails >= 3){
      showMsg("Too many failed attempts. Please refresh the page.");
      submitBtn.disabled = true;
      submitBtn.style.opacity = "0.6";
      return;
    }

    showMsg("Incorrect CAPTCHA");
    refreshCaptcha();
    return;
  }

  // ‚úÖ CAPTCHA passed ‚Üí reset counter
  captchaFails = 0;

  /* =================================================
     SIGNUP FLOW
  ================================================= */
  if(isSignup){

    if(password.value !== confirmPassword.value)
      return showMsg("Passwords do not match");

    if(!acceptTnc.checked)
      return showMsg("Accept Terms & Conditions");

    auth.createUserWithEmailAndPassword(
      email.value.trim(),
      password.value
    )
    .then(u=>{
      // üìß Send verification email
      u.user.sendEmailVerification();

      // üîí Disable submit to prevent re-click spam
      submitBtn.disabled = true;
      submitBtn.style.opacity = "0.6";

      verifyMsg.style.display = "block";
      showMsg("");

      // ‚õî Force logout until email verified
      auth.signOut();
    })
    .catch(e=>{
      showMsg(e.message);
      refreshCaptcha();
    });

    return;
  }

  /* =================================================
     LOGIN FLOW (BRUTE FORCE HARDENED)
  ================================================= */

  // üîí Check login lock (5 failures / 15 mins)
  if(isLoginLocked()){
    showMsg("Too many failed logins. Try again after 15 minutes.");
    return;
  }

  auth.signInWithEmailAndPassword(
    email.value.trim(),
    password.value
  )
  .then(r=>{
    if(!r.user.emailVerified){
      auth.signOut();
      recordLoginFailure();      // ‚ùå count failed login
      showMsg("Verify email first");
      refreshCaptcha();
      return;
    }

    // ‚úÖ Successful login
    resetLoginFailures();
    showMsg("");
  })
  .catch(()=>{
    recordLoginFailure();        // ‚ùå count failed login
    showMsg("Invalid email or password");
    refreshCaptcha();
  });
}



/* ================= PASSWORD RESET ================= */
function forgotPassword(){
  if (!email.value.trim()) {
    showMsg("Enter registered email first");
    return;
  }

  auth.sendPasswordResetEmail(email.value.trim())
    .then(() => {
      showMsg("Password reset email sent. Check inbox / spam.");
    })
    .catch(err => {
      showMsg(err.message);
    });
}


/* ================= INIT ================= */
window.onload=drawCaptcha;
</script>

</body>
</html>

