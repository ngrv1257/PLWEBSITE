<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Font Converter ‚Äì Unicode ‚áÑ Amar</title>

<!-- DOCX handling from browser -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<!-- ========= GLOBAL THEME (Apple-style, royal blue) ========= -->
<style>
  :root {
    --bg-main: #f5f5f7;
    --card-bg: #ffffff;
    --border-soft: #e0e0e5;
    --accent: #0050d6;          /* Royal blue */
    --accent-soft: #e3edff;
    --accent-dark: #0037a3;
    --text-main: #111111;
    --text-muted: #6b6b76;
    --radius-card: 18px;
    --radius-field: 12px;
    --shadow-soft: 0 18px 35px rgba(0,0,0,0.08);
    --shadow-very-soft: 0 10px 24px rgba(15,23,42,0.08);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    background: radial-gradient(circle at top left, #eef2ff 0, #f5f5f7 42%, #fdfdfd 100%);
    color: var(--text-main);
  }

  /* Shell to center everything like a SaaS app */
  .app-shell {
    min-height: 100vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 32px 12px 60px;
  }

  .container {
    width: 100%;
    max-width: 980px;
    background: var(--card-bg);
    border-radius: 26px;
    padding: 24px 24px 28px;
    box-shadow: var(--shadow-soft);
    border: 1px solid rgba(255,255,255,0.9);
    backdrop-filter: blur(10px);
  }

  /* Top header row */
  .app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 18px;
  }

  .app-title {
    font-size: 22px;
    font-weight: 650;
    letter-spacing: 0.03em;
    color: #0b0b12;
  }

  .app-subtitle {
    font-size: 13px;
    color: var(--text-muted);
  }

  /* Converter ‚Äúcards‚Äù inside container */
  .card {
    border-radius: var(--radius-card);
    background: #fafafa;
    border: 1px solid var(--border-soft);
    box-shadow: var(--shadow-very-soft);
    padding: 18px 18px 18px;
    margin-bottom: 18px;
  }

  .card-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
  }

  .card-title {
    font-size: 16px;
    font-weight: 600;
    color: #111827;
  }

  .card-subtitle {
    font-size: 12px;
    color: var(--text-muted);
  }

  label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    margin: 6px 0 4px;
    color: #111827;
  }

  textarea {
    width: 100%;
    min-height: 150px;
    font-size: 15px;
    line-height: 1.5;
    padding: 11px 12px;
    border-radius: var(--radius-field);
    border: 1px solid #d4d4dd;
    resize: vertical;
    outline: none;
    background: #ffffff;
    transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
  }

  textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(0,80,214,0.55);
    background: #ffffff;
  }

  .btn-row {
    margin: 10px 0 4px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  button {
    flex: 1;
    min-width: 140px;
    padding: 9px 16px;
    border-radius: 999px;
    border: none;
    background: var(--accent);
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    letter-spacing: 0.02em;
    box-shadow: 0 8px 14px rgba(0,80,214,0.22);
    transition: background 0.16s ease, transform 0.08s ease, box-shadow 0.16s ease, opacity 0.1s ease;
  }

  button:hover {
    background: var(--accent-dark);
    transform: translateY(-1px);
    box-shadow: 0 12px 22px rgba(0,80,214,0.26);
  }

  button:active {
    transform: translateY(0);
    box-shadow: 0 6px 10px rgba(0,80,214,0.18);
  }

  button.secondary {
    background: #f3f4ff;
    color: #1e293b;
    box-shadow: none;
    border: 1px solid #d8def6;
  }
  button.secondary:hover {
    background: #e4e7ff;
  }

  /* ‚ÄúAdd Mapping‚Äù special styling */
  .btn-add-mapping {
    background: #002c80;
    color: #ffd700;
    border-radius: 999px;
    box-shadow: 0 10px 18px rgba(0,44,128,0.35);
    padding-inline: 20px;
    flex: 0 0 auto;
  }
  .btn-add-mapping:hover {
    background: #001f5a;
  }

  hr {
    border: none;
    border-top: 1px solid #e2e2ee;
    margin: 18px 0;
  }

  .docx-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  @media (max-width: 720px) {
    .app-shell {
      padding: 18px 10px 42px;
      align-items: stretch;
    }
    .container {
      padding: 16px 14px 20px;
      border-radius: 18px;
    }
    .app-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .btn-row {
      flex-direction: column;
    }
    button {
      flex: none;
      width: 100%;
    }
  }

  /* ===== PASSWORD OVERLAY ===== */
  #lockScreen {
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at top, rgba(255,255,255,0.15), rgba(0,0,0,0.6));
    backdrop-filter: blur(16px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #lockBox {
    background: rgba(255,255,255,0.96);
    color: #111827;
    width: 420px;
    max-width: 90%;
    padding: 26px 24px 24px;
    border-radius: 24px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(15,23,42,0.28);
    border: 1px solid rgba(255,255,255,0.9);
    animation: fadeIn 0.35s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-18px) scale(0.98); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  #lockBox h2 {
    margin-top: 0;
    font-size: 22px;
    font-weight: 650;
  }

  #attemptInfo {
    margin: 8px 0 16px;
    font-size: 13px;
    color: #6b7280;
  }

  #keyInputBox {
    position: relative;
    width: 100%;
    margin-top: 4px;
  }

  #securityKey {
    width: 100%;
    padding: 11px 42px 11px 14px;
    border-radius: 999px;
    border: 1px solid #d4d4dd;
    outline: none;
    font-size: 16px;
    background: #f9fafb;
    transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
  }

  #securityKey:focus {
    border-color: #0050d6;
    background: #ffffff;
    box-shadow: 0 0 0 1px rgba(0,80,214,0.45);
  }

  #toggleEye {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    cursor: pointer;
    user-select: none;
  }

  #unlockBtn {
    width: 100%;
    margin-top: 18px;
    padding: 11px;
    background: #0050d6;
    border: none;
    color: white;
    border-radius: 999px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    box-shadow: 0 12px 24px rgba(0,80,214,0.35);
    transition: background 0.16s ease, transform 0.08s ease, box-shadow 0.16s ease;
  }

  #unlockBtn:hover {
    background: #003b9f;
    transform: translateY(-1px);
    box-shadow: 0 16px 30px rgba(0,80,214,0.40);
  }

  #unlockBtn:active {
    transform: translateY(0);
    box-shadow: 0 8px 16px rgba(0,80,214,0.28);
  }

  /* ===== ADD-MAPPING MODAL ===== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.55);
    backdrop-filter: blur(12px);
    display: none; /* default hidden */
    justify-content: center;
    align-items: center;
    z-index: 999999;
  }

  .modal-box {
    width: 420px;
    max-width: 90%;
    background: #ffffff;
    padding: 24px 22px 18px;
    border-radius: 22px;
    color: #0f172a;
    box-shadow: 0 18px 36px rgba(15,23,42,0.35);
    border: 1px solid rgba(255,255,255,0.9);
    animation: fadeInScale 0.25s ease-out;
  }

  @keyframes fadeInScale {
    from { opacity: 0; transform: translateY(10px) scale(0.96); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  .modal-box h2 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 14px;
    font-size: 18px;
    font-weight: 600;
  }

  .modal-box label {
    font-size: 13px;
    margin-top: 6px;
    display: block;
    color: #111827;
  }

  .modal-box input {
    width: 100%;
    padding: 9px 11px;
    border-radius: 11px;
    border: 1px solid #d4d4dd;
    margin-top: 4px;
    margin-bottom: 6px;
    font-size: 15px;
    outline: none;
    background: #f9fafb;
    transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
  }

  .modal-box input:focus {
    border-color: #0050d6;
    background: #ffffff;
    box-shadow: 0 0 0 1px rgba(0,80,214,0.45);
  }

  .modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 10px;
  }

  .modal-buttons button {
    flex: 0 0 auto;
    min-width: 90px;
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 14px;
    cursor: pointer;
    border: none;
  }

  .modal-buttons button:first-child {
    background: #f3f4f6;
    color: #111827;
  }

  .modal-buttons button:first-child:hover {
    background: #e5e7eb;
  }

  .modal-buttons .blue {
    background: #0050d6;
    color: #ffffff;
    box-shadow: 0 10px 18px rgba(0,80,214,0.28);
  }

  .modal-buttons .blue:hover {
    background: #003ea6;
  }

  /* Footer watermark */
  #kgFooter {
    position: fixed;
    bottom: 10px;
    right: 12px;
    font-size: 11px;
    font-family: system-ui, -apple-system, "SF Pro Text", sans-serif;
    color: #6b7280;
    background: rgba(255,255,255,0.85);
    padding: 5px 9px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    pointer-events: none;
  }
</style>
</head>

<body>

<!-- ================= PASSWORD SECURITY OVERLAY ================= -->
<div id="lockScreen">
  <div id="lockBox">
    <h2>üîê Enter Security Key</h2>
    <div id="attemptInfo">You have <b>3</b> attempts remaining</div>

    <div id="keyInputBox">
      <input type="password" id="securityKey" placeholder="Enter key‚Ä¶" />
      <span id="toggleEye">üëÅÔ∏è</span>
    </div>

    <button id="unlockBtn">Unlock</button>
  </div>
</div>

<!-- ================= MAIN APP SHELL ================= -->
<div class="app-shell">
  <div class="container">

    <div class="app-header">
      <div>
        <div class="app-title">Font Converter ‚Äì Unicode ‚áÑ Amar</div>
        <div class="app-subtitle">Internal KG & NB tool ‚Ä¢ Amar Hindi mapping engine</div>
      </div>

      <button class="btn-add-mapping" onclick="openAddMapping()">
        ‚ûï Add Missing Mapping
      </button>
    </div>

    <!-- CARD 1 ‚Äì TEXT CONVERTER -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Text Conversion</div>
        <div class="card-subtitle">Paste Unicode, convert to Amar codes and copy for Word (AmrHindi font).</div>
      </div>

      <label><b>Unicode Input</b></label>
      <textarea id="unicodeInput" placeholder="Type or paste Unicode text here‚Ä¶"></textarea>

      <div class="btn-row">
        <button onclick="handleUnicodeToAmar()">Unicode ‚Üí Amar</button>
        <button class="secondary" onclick="copyAmar()">Copy Amar Output</button>
      </div>

      <label><b>Amar Output</b></label>
      <textarea id="amarOutput" placeholder="Amar Hindi output will appear here‚Ä¶"></textarea>
    </div>

    <!-- CARD 2 ‚Äì DOCX CONVERTER -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">DOCX Converter</div>
        <div class="card-subtitle">Upload Unicode .docx ‚Üí download Amar .docx with AmrHindi applied on runs.</div>
      </div>

      <input type="file" id="docxFile" accept=".docx" />
      <div class="btn-row" style="margin-top:10px;">
        <button onclick="convertDocx()">Convert & Download DOCX</button>
      </div>

      <div class="docx-hint">
        Tip: Open the converted file in Word ‚Äì the text will already be in Amar codes with <b>AmrHindi</b> font.
      </div>
    </div>

  </div>
</div>

<!-- ================= ADD-MAPPING MODAL ================= -->
<div id="addMappingModal" class="modal-overlay">
  <div class="modal-box">
    <h2>‚ûï Add Missing Mapping</h2>

    <label>Unicode (Left side)</label>
    <input id="modalUnicode" type="text" placeholder="Enter Unicode‚Ä¶" />

    <label>Amar Output (Right side)</label>
    <input id="modalAmar" type="text" placeholder="Enter Amar‚Ä¶" />

    <label>Security Key</label>
    <input id="modalKey" type="password" placeholder="Enter security key‚Ä¶" />

    <div class="modal-buttons">
      <button onclick="closeAddMapping()">Cancel</button>
      <button class="blue" onclick="saveNewMapping()">Save Mapping</button>
    </div>
  </div>
</div>

<!-- FOOTER WATERMARK -->
<div id="kgFooter">
  Copyright@2025 by KG & NB! This module cannot be used commercially and without permission.
</div>

<!-- =================== ALL JAVASCRIPT LOGIC =================== -->
<script>
/* ============================================================
   PASSWORD LOCK LOGIC
============================================================ */
const CORRECT_KEY = "251479";
let attempts = 3;

const lockScreen = document.getElementById("lockScreen");
const keyInput   = document.getElementById("securityKey");
const attemptInfo = document.getElementById("attemptInfo");

document.getElementById("toggleEye").onclick = () => {
  keyInput.type = keyInput.type === "text" ? "password" : "text";
};

keyInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") unlock();
});

document.getElementById("unlockBtn").onclick = unlock;

function unlock() {
  const val = keyInput.value.trim();

  if (val === CORRECT_KEY) {
    lockScreen.style.display = "none";
    return;
  }

  attempts--;
  attemptInfo.innerHTML = `You have <b>${attempts}</b> attempts remaining`;
  keyInput.value = "";

  if (attempts <= 0) {
    alert("Access denied. Browser will now close this tab.");
    window.close();
    location.href = "about:blank"; // fallback
  }
}

/* Close add-mapping modal on ESC */
document.addEventListener("keydown", e => {
  if (e.key === "Escape") closeAddMapping();
});

/* ============================================================
   ADD-MAPPING MODAL OPEN/CLOSE
============================================================ */
function openAddMapping() {
  document.getElementById("modalUnicode").value = "";
  document.getElementById("modalAmar").value = "";
  document.getElementById("modalKey").value = "";
  document.getElementById("addMappingModal").style.display = "flex";
}

function closeAddMapping() {
  document.getElementById("addMappingModal").style.display = "none";
}

/* ============================================================
   PART 1 ‚Äì BASE SIMPLE LETTER MAPPING (MAP_LETTERS)
============================================================ */
const MAP_LETTERS = {
  "‡§ï":"k","‡§ñ":"K","‡§ó":"g","‡§ò":"G","‡§ô":"|",
  "‡§ö":"c","‡§õ":"C","‡§ú":"j","‡§ù":"J","‡§û":"\\",
  "‡§ü":"t","‡§†":"T","‡§°":"f","‡§¢":"F","‡§£":"x",
  "‡§§":"q","‡§•":"Q","‡§¶":"d","‡§ß":"D","‡§®":"n",
  "‡§™":"p","‡§´":"P","‡§¨":"b","‡§≠":"B","‡§Æ":"m",
  "‡§Ø":"X","‡§∞":"r","‡§≤":"l","‡§µ":"v",
  "‡§∂":"S","‡§∑":"‚Ä†","‡§∏":"s","‡§π":"h",

  "‡§Ü":"Aw","‡§Ö":"A","‡§á":"e","‡§à":"e~",
  "‡§â":"a","‡§ä":"‚Äö","‡§è":"E","‡§ê":"Ey","‡§ì":"Ao","‡§î":"AO",

  "‡§Ç":"<","‡§Å":">","‡§æ":"w","‡§ø":"i","‡•Ä":"I","‡•Å":"u","‡•Ç":"U",
  "‡•á":"y","‡•à":"Y","‡•ã":"o","‡•å":"O","‡•É":"√∑",

  "‡•§":"[","‡••":"[[","-":"-","=":"=",
  "‡•¶":"0","‡•ß":"1","‡•®":"2","‡•©":"3","‡•™":"4",
  "‡•´":"5","‡•¨":"6","‡•≠":"7","‡•Æ":"8","‡•Ø":"9",
  "‡§º":"¬°","‡§±":"X¬°"
};

/* ============================================================
   PART 2 ‚Äì HALF-CONSONANTS SET A (MAP_HALFA)
   Used when ANY consonant follows after halant
============================================================ */
const MAP_HALFA = {
  "‡§ï‡•ç":"#","‡§ñ‡•ç":"$","‡§ó‡•ç":"^","‡§ò‡•ç":"%","‡§ô‡•ç":"√ß","‡§ö‡•ç":"√á","‡§õ‡•ç":"C",
  "‡§ú‡•ç":"√à","‡§ù‡•ç":"√â","‡§û‡•ç":"√ä","‡§ü‡•ç":"√®","‡§†‡•ç":"T`","‡§°‡•ç":"√©","‡§¢‡•ç":"F",
  "‡§£‡•ç":"&","‡§§‡•ç":"√ã","‡§•‡•ç":"√å","‡§ß‡•ç":"√ç","‡§®‡•ç":"N","‡§™‡•ç":"√é","‡§∂‡•ç‚Äç":"√ú","‡§∏‡•ç":"√°","‡§∑‡•ç":"√†",
  "‡§´‡•ç":"√è","‡§¨‡•ç":"√ë","‡§Æ‡•ç":"M","‡§≠‡•ç":"√í","‡§≤‡•ç":"√ò","‡§µ‡•ç":"√õ","‡§µ‡•ç":"√õ","‡§µ‡•ç":"√õ","‡§µ‡•ç":"√õ",
  "‡§∞‡•ç":"r`"
};

/* ============================================================
   PART 3 ‚Äì HALF-CONSONANTS SET B (MAP_HALFB)
   Used when NO consonant follows after halant
============================================================ */
const MAP_HALFB = {
  "‡§ï‡•ç":"k`","‡§ñ‡•ç":"K`","‡§ó‡•ç":"g`","‡§ò‡•ç":"G`","‡§ô‡•ç":"|`",
  "‡§ö‡•ç":"c`","‡§õ‡•ç":"C`","‡§ú‡•ç":"j`","‡§ù‡•ç":"J`","‡§û‡•ç":"\\`",
  "‡§ü‡•ç":"t`","‡§†‡•ç":"T`","‡§°‡•ç":"f`","‡§¢‡•ç":"F`","‡§£‡•ç":"x`",
  "‡§§‡•ç":"q`","‡§•‡•ç":"Q`","‡§¶‡•ç":"d`","‡§ß‡•ç":"D`","‡§®‡•ç":"n`",
  "‡§™‡•ç":"p`","‡§´‡•ç":"P`","‡§¨‡•ç":"b`","‡§≠‡•ç":"B`","‡§Æ‡•ç":"m`",
  "‡§Ø‡•ç":"X`","‡§∞‡•ç‡§ï‡•ç":"k~`","‡§≤‡•ç":"l`","‡§µ‡•ç":"v`",
  "‡§∂‡•ç":"S`","‡§∑‡•ç":"‚Ä†`","‡§∏‡•ç":"s`","‡§π‡•ç":"h`"
};

/* ============================================================
   PART 4 ‚Äì CONJUNCTS (MAP_CONJ)
   Highest priority after words
============================================================ */
const MAP_CONJ = {
  /* ==== Existing approved conjuncts ==== */
  "‡§ï‡•ç‡§ï":"Àú","‡§¶‡•ç‡§ó":"√™√Æ","‡§¶‡•ç‡§ò":"√™√≤","‡§¶‡•ç‡§¶":"¬®","‡§¶‡•ç‡§¨":"√™√¥","‡§¶‡•ç‡§≠":"√™B","‡§∑‡•ç‡§ü‡•ç‡§∞":"√†t√∂",
  "‡§¶‡•ç‡§Æ":"¬Æ","‡§¶‡•ç‡§µ":"√™√π","‡§¶‡•ç‡§∞":"dR","‡§ï‡•É":"‚Ñ¢","‡§ï‡•ç‡§§‡•ç‡§∞":"√ÇR","‡§ï‡•ç‡§§‡•ç‡§µ":"√Ç√π",
  "‡§ï‡•ç‡§§‡•ç‡§∏":"√Ç`s","‡§ï‡•ç‡§ï‡•ç‡§∑":"Àú`‚Ä†","‡§ï‡•ç‡§ï‡•ç‡§≤":"Àú¬¨","‡§ï‡•ç‡§∞":"k√µ","‡§¶‡•ç‡§ß":"¬©",
  "‡§≠‡•ç‡§∞":"BR","‡§π‡•ç‡§®":"Hn","‡§ü‡•ç‡§∞":"t√∂","‡§π‡•ç‡§Æ":"Hm","‡§π‡•ç‡§µ":"Hv","‡§π‡•ç‡§Ø":"HX","‡§π‡•ç‡§≤":"Hl",

  "‡§ï‡•ç‡§∑‡•ç‡§£":"√¢x","‡§∏‡•ç‡§ï‡•ç‡§≤‡•ç‡§Ø‡•à":"√°‚Ä∫√îY","‡§¶‡•ç‡§Æ‡•ç‡§Ø":"¬Æ√î","‡§∏‡•ç‡§´‡•ç‡§Ø‡§ï‡•ç‡§§":"√°√èX√Ç","‡§¶‡•ç‡§¨‡•ç‡§Ø‡•å":"√™√¥√îO","‡§∞‡•ç‡§ú‡•ç‡§û‡•ç‡§Ø":"√•X~",
  "‡§ó‡•ç‡§®‡•ç‡§Ø":"^NX","‡§¶‡•ç‡§ò‡•ç‡§Æ‡•ç‡§Ø":"√™√≤`MX","‡§π‡•ç‡§®‡•ç‡§Ø":"HNX",
  "‡§∂‡•ç‡§Æ‡•ç‡§Ø":"√úMX","‡§¶‡•ç‡§¨‡•ç‡§ß‡•ç‡§Ø":"√™√¥`√çX","‡§∑‡•ç‡§™‡•ç‡§§‡•ç‡§Ø":"√†√é√ãX","‡§π‡•ç‡§≤‡•ç‡§Ø":"H√òX","‡§∞‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø‡•à":"√£XY~",
  "‡§¶‡•ç‡§ó‡•ç‡§ß‡•ç‡§Ø":"√™√Æ`√çX","‡§¶‡•ç‡§ò‡•ç‡§∞‡•ç‡§Ø":"√™√≤R√î","‡§¶‡•ç‡§∂‡•ç‡§∞‡•ç‡§Ø":"√™‚Ä∞√î","‡§¶‡•ç‡§∏‡•ç‡§ï‡•ç‡§Ø":"√™√°#X",
  "‡§£‡•ç‡§Æ‡•ç‡§Ø":"&MX","‡§∞‡•ç‡§£‡•ç‡§°‡•ç‡§∞‡•ç‡§Ø":"&f√∂√î~","‡§∑‡•ç‡§ï‡•ç‡§≤‡•ç‡§Ø":"√†‚Ä∫√î","‡§∞‡•ç‡§§‡•ç‡§∏‡•ç‡§µ‡•ç‡§Ø":"√ã√°√õX~","‡§∞‡•ç‡§ó‡•ç‡§≤‡•ç‡§Ø":"^√òX~",
  "‡§∞‡•ç‡§∂‡•ç‡§∞‡•ç‡§Ø":"‚Ä∞√î~","‡§∞‡•ç‡§∏‡•ç‡§•‡•ç‡§Ø":"√°√åX~","‡§∞‡•ç‡§π‡•ç‡§®‡•ç‡§Ø":"HNX~","‡§ï‡•ç‡§≤‡•ç‡§Ø‡•à":"‚Ä∫√îY","‡§¶‡•ç‡§∞‡•ç‡§Ø":"dR√î",
  "‡§¶‡•ç‡§Æ‡•ç‡§®‡•ç‡§Ø":"¬Æ√≥√î","‡§∑‡•ç‡§£‡•ç‡§Ø":"√†&X","‡§¶‡•ç‡§µ‡•ç‡§Ø":"√™√π√î","‡§∞‡•ç‡§£‡•ç‡§µ‡•ç‡§Ø":"&√õX~","‡§§‡•ç‡§∞‡•ç‡§Ø":"√£X",
  "‡§∞‡•ç‡§ó‡•ç‡§∑‡•ç‡§£‡•ç‡§Ø":"^√†&X~","‡§¶‡•ç‡§ß‡•ç‡§Ø":"¬©√î",

  "‡§™‡•ç‡§∞":"pR","‡§§‡•ç‡§∞":"Z","‡§ú‡•ç‡§û":"z","‡§ú‡•ç‡§û‡§æ":"zw","‡§ú‡•ç‡§û‡•á":"zy",
  "‡§∂‡•ç‡§∞":"‚Ä∞","‡§∂‡•ç‡§∞‡•á":"‚Ä∞y","‡§∂‡•ç‡§∞‡§æ":"‚Ä∞w",

  "‡§¶‡•ç‡§Ø":"¬¥","‡§¶‡•ç‡§Ø‡•Å":"¬¥u",

  "‡§∏‡•ç‡§§‡•ç‡§∞":"√°Z","‡§∏‡•ç‡§§‡•ç‡§∞‡§æ":"√°Zw","‡§∏‡•ç‡§§‡•ç‡§∞‡•à":"√°ZY",

  "‡§Æ‡•ç‡§®":"Mn","‡§ó‡•ç‡§®":"^n","‡§Ö‡§ó‡•ç‡§®‡§ø":"Ai^n",

  "‡§ï‡•ç‡§§":"√Ç","‡§ï‡•ç‡§§‡•ç‡§µ‡§æ":"√Ç√πw",

  "‡§∏‡•ç‡§µ":"√°v","‡§∏‡•ç‡§µ‡§æ":"√°vw","‡§∏‡•ç‡§µ‡§É":"√°v√ö",

  "‡§π‡•ç‡§Æ":"Hm","‡§ï‡•ç‡§∑":"@","‡§ó‡•ç‡§∞":"gR",

  /* --- ‡§∏‡•ç‡§§-series --- */
  "‡§∏‡•ç‡§§":"√°q",
  "‡§∏‡•ç‡§§‡•ç‡§µ":"√°√ãv",
  "‡§∏‡•ç‡§®":"√°n",
  "‡§∏‡•ç‡§Æ":"√°m",
  "‡§∏‡•ç‡§ï":"√°k",
  "‡§∏‡•ç‡§ï‡•ç‡§∞":"√°k√µ",
  "‡§∏‡•ç‡§≤":"√°l",
  "‡§∏‡•ç‡§™":"√°p",
  "‡§∏‡•ç‡§´":"√°P",
  "‡§∏‡•ç‡§ï‡•ç‡§≤":"√°‚Ä∫",
  "‡§∏‡•ç‡§∂":"√°S",
  "‡§∏‡•ç‡§∏":"√°s",
  "‡§∏‡•ç‡§∏‡•ç‡§Æ":"√°√°m",
  "‡§∏‡•ç‡§∏‡•ç‡§µ":"√°√°v",
  "‡§∏‡•ç‡§∏‡•ç‡§ï":"√°√°k",
  "‡§∏‡•ç‡§∏‡•ç‡§®":"√°√°n",
  "‡§∏‡•ç‡§∏‡•ç‡§™":"√°√°p",
  "‡§∏‡•ç‡§∏‡•ç‡§•":"√°√°Q",
  "‡§∏‡•ç‡§∏‡•ç‡§µ‡•ç‡§Ø":"√°√°√õX",

  /* --- ‡§∂-series --- */
  "‡§∂‡•ç‡§®":"√ún",
  "‡§∂‡•ç‡§Æ":"√úm",
  "‡§∂‡•ç‡§µ":"√úv",
  "‡§∂‡•ç‡§§":"√úq",
  "‡§∂‡•ç‡§≤":"√úl",
  "‡§∂‡•ç‡§ï":"√úk",
  "‡§∂‡•ç‡§ö":"√úc",
  "‡§∂‡•ç‡§û":"√ú\\",
  "‡§∂‡•ç‡§´":"√úP",
  "‡§∂‡•ç‡§¨":"√úb",
  "‡§∂‡•ç‡§≠":"√úB",
  "‡§∂‡•ç‡§µ‡•ç‡§Ø":"√ú√õX",
  "‡§∂‡•ç‡§Ø":"√úX",

  /* --- ‡§∑-series --- */
  "‡§∑‡•ç‡§ü":"√†t",
  "‡§∑‡•ç‡§†":"√Ñ",
  "‡§∑‡•ç‡§£":"√†x",
  "‡§∑‡•ç‡§™":"√†p",
  "‡§∑‡•ç‡§ö":"√†c",
  "‡§∑‡•ç‡§µ":"√†v",
  "‡§∑‡•ç‡§Æ":"√†m",
  "‡§∑‡•ç‡§∞":"‚Ä†R",

  "‡§ï‡•ç‡§§‡•â":"√Çw","‡§§‡•ç‡§∞‡•â":"Zw","‡§¶‡•ç‡§∞‡•â":"dRw","‡§ï‡•ç‡§∞‡•â":"k√µw","‡§ó‡•ç‡§∞‡•â":"gRw","‡§™‡•ç‡§∞‡•â":"pRw","‡§¨‡•ç‡§∞‡•â":"bRw","‡§ß‡•ç‡§∞‡•â":"DRw","‡§∂‡•ç‡§∞‡•â":"‚Ä∞w",
  "‡§ï‡•â":"kw","‡§ñ‡•â":"Kw","‡§ó‡•â":"gw","‡§ò‡•â":"Gw","‡§ô‡•â":"|w","‡§ö‡•â":"cw","‡§õ‡•â":"Cw","‡§ú‡•â":"jw","‡§ù‡•â":"Jw",
  "‡§û‡•â":"\\w","‡§ü‡•â":"tw","‡§†‡•â":"Tw","‡§°‡•â":"fw","‡§¢‡•â":"Fw","‡§£‡•â":"xw","‡§§‡•â":"qw","‡§•‡•â":"Qw","‡§¶‡•â":"dw","‡§ß‡•â":"Dw",
  "‡§®‡•â":"nw","‡§™‡•â":"pw","‡§´‡•â":"Pw","‡§¨‡•â":"bw","‡§≠‡•â":"Bw","‡§Æ‡•â":"mw","‡§Ø‡•â":"Xw","‡§∞‡•â":"rw","‡§≤‡•â":"lw","‡§µ‡•â":"vw",
  "‡§∂‡•â":"Sw","‡§∑‡•â":"‚Ä†w","‡§∏‡•â":"sw","‡§π‡•â":"hw",

  "‡§Ø‡§É":"X√ö","‡§∏‡•ç‡§§‡•ç‡§Ø":"√°√ãX","‡§π‡•ç‡§®‡§É":"Hn√ö","‡§∞‡§É":"r√ö","‡§¨‡•ç‡§ß‡§É":"√ëD√ö","‡§ï‡•ç‡§∑‡•ç‡§Æ":"√¢m","‡§∞‡•ç‡§•‡§É":"Q~√ö",
  "‡§∑‡•ç‡§ü‡•ç‚Äå":"√†t`","‡§ß‡§É":"D√ö","‡§•‡§É":"Q√ö","‡§ï‡•ç‡§§‡•ç‚Äå‡§∏‡•ç‡§®":"√Ç`√°n","‡§®‡•ç‡§§‡§É":"Nq√ö","‡§∞‡•ç‡§ï‡•ç‡§∑‡•ç‡§Ø":"√¢X~","‡§Æ‡§É":"m√ö","‡§ï‡•ç‡§§‡•ç‡§Ø":"√Ç√î","‡§ï‡•ç‡§§‡§É":"√Ç√ö","‡§≤‡§É":"l√ö","‡§£‡•ç‡§Ø‡§É":"&X√ö","‡§∏‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø":"√°√£X","‡§∏‡•ç‡§Æ‡•ç‡§Ø":"√°MX","‡§π‡•ç‡§∞‡•ç":"hR`",

  "‡§¶‡•ç‡§ß‡§ø‡§É":"i¬©√ö","‡§∑‡•ç‡§™‡•ç‡§∞":"√†pR","‡§µ‡•ç‡§Ø‡§É":"√õX√ö","‡§∞‡•ç‡§£‡•ç‡§ï‡•ç‡§§‡•ç‡§∞":"&√ÇR~","‡§™‡§É":"p√ö",

  /* --- final single --- */
  "‡§£‡•ç‡§Ø":"&X"
};

/* ZWJ-variant conjuncts for Word-style sequences (e.g. ‡§§‡•ç‚Äç‡§∞, ‡§∏‡•ç‚Äç‡§µ) */
const MAP_CONJ_ZWJ = {};
for (const key in MAP_CONJ) {
  if (key.includes("‡•ç")) {
    const zwjKey = key.replace(/‡•ç/g, "‡•ç‚Äç");  // halant + ZWJ
    MAP_CONJ_ZWJ[zwjKey] = MAP_CONJ[key];
  }
}

/* ============================================================
   PART 5 ‚Äì WORD EXCEPTIONS (MAP_WORDS)
============================================================ */
const MAP_WORDS = {
  "‡§§‡•ç‡§∞‡§ø‡§ï‡•Ç‡§ü":"iZkUt","‡§∞‡•Å":"{","‡§§‡•ç‡§∞‡§ø‡§™‡•É‡§∑‡•ç‡§†":"iZp√∑√Ñ","‡§§‡•ç‡§∞‡§ø‡§µ‡•á‡§£‡•Ä":"iZvyxI","‡§ï‡•ç‡§≤‡•ç‡§Ø‡•å":"‚Ä∫√îO","‡§∞‡•Ç":"}","‡§µ‡§É":"v√ö","‡§®‡§É":"n√ö",
  "‡§§‡•ç‡§∞‡§ø‡§∂‡•Ç‡§≤":"iZSUl","‡§§‡•ç‡§µ‡•ç‡§Ø":"√ã√õX","‡§ã‡§∑‡•Ä":"ÀÜ‚Ä†I","‡§∑‡•Ä":"‚Ä†I","‡§Æ‡•ç‡§∞":"mR","‡§∏‡•ç‡§§‡•ç‡§∞‡•à‡§£‡•ç‡§Ø":"√°ZY&X","‡§ï‡•ç‡§Ø":"#X","‡§£‡•ç‡§Ø":"&X","‡§¶‡•ç‡§≠‡•ç‡§∞":"√™BR",
  "‡§§‡•ç‡§∞‡§æ‡§∏‡§¶‡•Ä":"ZwsdI","‡§ú‡•ç‡§û‡§æ‡§®‡•á‡§∂‡•ç‡§µ‡§∞":"zwny√úvr","‡§ú‡•ç‡§û‡§æ‡§®‡§ï‡•ã‡§∂":"zwnkoS","‡§∞‡•ç‡§£":"x~","‡§∞‡•ç‡§£‡•ç‡§Ø":"&X~","‡§∞‡•ç‡§£‡•ç‡§µ":"&v~","‡§∞‡•ç‡§£‡•ç‡§Æ":"&m~","‡§∞‡•ç‡§£‡•ç‡§®":"&n~","‡§¶‡•ç‡§ò‡•ç‡§®‡•ç‡§Ø":"√™√≤√≥√î",
  "‡§∞‡•ç‡§£‡•ç‡§°":"&f~","‡§∞‡•ç‡§£‡•ç‡§ß":"&D~","‡§∞‡•ç‡§£‡•ç‡§ó":"&g~","‡§∞‡•ç‡§£‡•ç‡§ï":"&k~","‡§∞‡•ç‡§£‡•ç‡§†":"&T~","‡§∞‡•ç‡§£‡•ç‡§ü":"&t~","‡§∞‡•ç‡§£‡•ç‡§™":"&p~","‡§∞‡•ç‡§£‡•ç‡§≠":"&B~","‡§∞‡•ç‡§£‡•ç‡§∏":"&s~","‡§∞‡•ç‡§£‡•ç‡§Ø":"&X~",
  "‡§∞‡•ç‡§£‡•ç‡§∑":"&‚Ä†~","‡§∞‡•ç‡§£‡•ç‡§ú":"&j~","‡§∞‡•ç‡§£‡•ç‡§§":"&q~","‡§∞‡•ç‡§£‡•ç‡§Æ‡•ç‡§Ø":"&MX~","üî• ":"üî• ","‡§∞‡•ç‡§®‡•ç‡§Ø":"NX~","‡§∞‡•ç‡§Æ‡•ç‡§Ø":"MX~","‡§∞‡•ç‡§∏‡•ç‡§Ø":"√°X~","‡§∞‡•ç‡§§‡•ç‡§Ø":"√ãX~",
  "‡§∞‡•ç‡§•‡•ç‡§Ø":"√åX~","‡§∞‡•ç‡§ú‡•ç‡§Ø":"√àX~","‡§∞‡•ç‡§ï‡•ç‡§Ø":"#X~","‡§∞‡•ç‡§µ‡•ç‡§Ø":"√õX~","‡§∞‡•ç‡§ò‡•ç‡§Ø":"%X~","‡§∞‡•ç‡§π‡•ç‡§Ø":"HX~","‡§π‡•ç‡§∞":"hR","‡§£‡•ç‡§Ø‡§É":"&X√ö","‡§ï‡•ç‡§§‡§ø‡§É":"i√Ç√ö","‡§π‡•ç‡§∞‡•ç‡§Ø":"hR√î","‡§∏‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø":"√°√£X","‡§ï‡•ç‡§∑‡•ç‡§Æ‡•ç‡§Ø":"√¢MX","‡§∏‡•ç‡§§‡•ç‡§∞‡•ç‡§Ø":"√°√£X","‡§∂‡•ç‡§∞‡•ç‡§Ø":"‚Ä∞√î",

  "‡§µ‡§ø‡§ú‡•ç‡§û‡§™‡•ç‡§§‡§ø":"ivzi√éq","‡§™‡•ç‡§∞‡§ú‡•ç‡§û‡§æ":"pRzw","‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ":"s<zw",
  "‡§ï‡•ç‡§∑‡§∞‡§£":"@rx","‡§ï‡•ç‡§∑‡§§‡•ç‡§∞‡§ø‡§Ø":"@iZX","‡§ï‡•ç‡§∑‡§Æ‡§æ‡§∂‡•Ä‡§≤":"@mwSIl",
  "‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü":"a√ã‚Ñ¢√†t","‡§ï‡•É‡§∑‡•ç‡§£":"‚Ñ¢√†x","‡§Ö‡§ï‡•ç‡§∑‡§∞":"A@r",
  "‡§∂‡•ç‡§∞‡§µ‡§£":"‚Ä∞vx","‡§∂‡•ç‡§∞‡•á‡§Ø‡§æ":"‚Ä∞yXw","‡§∂‡•ç‡§∞‡§Æ‡§ø‡§ï":"‚Ä∞imk",
  "‡§∂‡•ç‡§∞‡•á‡§Ø‡§∏‡•ç‡§ï‡§∞":"‚Ä∞yX√°kr","‡§∂‡•ç‡§∞‡§¶‡•ç‡§ß‡§æ":"‚Ä∞¬©w",
  "‡§µ‡§ø‡§¶‡•ç‡§Ø‡•Å‡§§":"iv¬¥uq","‡§®‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§≤‡§Ø":"NXwXwlX","‡§â‡§¶‡•ç‡§Ø‡§æ‡§®":"a¬¥wn","‡§¶‡•ç‡§Ø‡•Å‡§§‡§ø":"¬¥uiq",
  "‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§§‡•ç‡§Æ":"A√çXw√ãm","‡§ß‡•ç‡§Ø":"√çX","‡§ß‡•ç‡§Ø‡§æ‡§®":"√çXwn",
  "‡§Ö‡§ß‡•ç‡§Ø‡§Ø‡§®":"A√çXXn","‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§Ø":"A√çXwX","‡§¶‡•ç‡§ò‡•ç‡§®":"√™√≤√≥","‡§¶‡•ç‡§ó‡•ç‡§ß":"√™√Æ`D",

  "‡§Æ‡§ß‡•ç‡§Ø‡§™‡•ç‡§∞‡§¶‡•á‡§∂":"m√çXpRdyS","‡§∏‡§æ‡§ß‡•ç‡§Ø":"sw√çX","‡§§‡•ç‡§µ":"√ãv",
  "‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø‡§§‡•ç‡§µ":"s<√°‚Ñ¢iq√ãv","‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§§‡•ç‡§µ":"√õXi√Ç√ãv","‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä‡§§‡•ç‡§µ":"√°ZI√ãv",
  "‡§™‡§µ‡§ø‡§§‡•ç‡§∞‡§§‡•ç‡§µ":"pivZ√ãv","‡§Ü‡§§‡•ç‡§Æ‡§§‡•ç‡§µ":"Aw√ãm√ãv",

  "‡§∂‡•ç‡§µ":"√úv","‡§∂‡•ç‡§µ‡§∏‡§®":"√úvsn","‡§∂‡•ç‡§µ‡§æ‡§∏":"√úvws","‡§∂‡•ç‡§µ‡•á‡§§":"√úvyq","‡§§‡§É":"q√ö",
  "‡§∂‡•ç‡§µ‡§æ‡§®":"√úvwn","‡§∂‡•ç‡§µ‡•á‡§ö‡•ç‡§õ‡§æ":"√úvy√áCw",

  "‡§Ö‡§π‡•ç‡§®‡§ø‡§ï‡§æ":"AiHnkw","‡§™‡•ç‡§∞‡§π‡•ç‡§£":"pRHx","‡§¶‡§π‡•ç‡§®‡§ø":"diHn","‡§π‡§ø‡§Æ‡§æ‡§≤‡§Ø":"ihmwlX",
  "‡§â‡§®‡•ç‡§Æ‡•á‡§∑":"aNmy‚Ä†","‡§â‡§®‡•ç‡§Æ‡§æ‡§¶":"aNmwd","‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ":"bRHm","‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ‡§æ":"bRHmw",

  "‡§∏‡•ç‡§§‡•ç‡§∞":"√°Z","‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä":"√°ZI","‡§∏‡•ç‡§§‡•ç‡§∞‡•ã‡§§":"√°Zoq","‡§∏‡•ç‡§§‡•ç‡§∞‡•à‡§£":"√°ZYx",
  "‡§∏‡•ç‡§§‡•ç‡§∞‡•à‡§£‡§§‡§æ":"√°ZYxqw","‡§∏‡•ç‡§§‡•ç‡§∞‡•ã‡§§‡§∏‡•ç‡§µ‡§∞":"√°Zoq√°vr",

  "‡§ö‡§Æ‡§§‡•ç‡§ï‡§æ‡§∞‡§ø‡§ï:":"cm√ãkwirk:","‡§ö‡§ø‡§®‡•ç‡§Æ‡§Ø":"icNmX","‡§Æ‡§®‡§®":"mnn",
  "‡§Ö‡§Æ‡•ç‡§®‡§æ‡§Ø":"AMnwX","‡§®‡§ø‡§Æ‡•ç‡§®":"inMn","‡§∏‡•ç‡§Æ‡§∞‡§£":"√°mrx",

  "‡§ß‡§æ‡§§‡•ç‡§µ‡§∞‡•ç‡§•":"Dw√ãvQ~","‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§®":"s<Xojn",
  "‡§¶‡•Å‡§ó‡•ç‡§ß‡§ó‡•ç‡§®":"du^D^n","‡§∞‡§æ‡§ó‡•ç‡§®‡•ç‡§Ø":"rw^NX","‡§Ö‡§ó‡•ç‡§®‡§ø‡§¶‡•á‡§µ":"Ai^ndyv","‡§Ö‡§ó‡•ç‡§®‡§ø‡§ï‡•Å‡§Ç‡§°":"Ai^nku<f",

  "‡§â‡§ï‡•ç‡§§":"a√Ç","‡§≠‡•Å‡§ï‡•ç‡§§":"Bu√Ç","‡§Ø‡•Å‡§ï‡•ç‡§§":"Xu√Ç","‡§¶‡•É‡§∑‡•ç‡§ü":"d√∑√†t","‡§≠‡§ï‡•ç‡§§‡§ø":"Bi√Ç",
  "‡§∏‡•ç‡§µ‡§∏‡•ç‡§§‡§ø‡§™‡•ç‡§∞‡§ú‡§æ‡§≠‡•ç‡§Ø‡§É":"√°vi√°qpRjw√íX√ö",

  "‡§™‡§∞‡§ø‡§™‡§æ‡§≤‡§Ø‡§®‡•ç‡§§‡§æ‡§Ç":"pirpwlXNqw<","‡§®‡•ç‡§Ø‡§æ‡§Ø‡•á‡§®":"NXwXyn","‡§Æ‡§æ‡§∞‡•ç‡§ó‡•á‡§£":"mwgy~x",
  "‡§ó‡•ã‡§¨‡•ç‡§∞‡§æ‡§π‡•ç‡§Æ‡§£‡•á‡§≠‡•ç‡§Ø‡§É":"gobRwHmxy√íX√ö","‡§∂‡•Å‡§≠‡§Æ‡§∏‡•ç‡§§‡•Å":"SuBm√°qu","‡§®‡§ø‡§§‡•ç‡§Ø‡§Ç":"in√ãX<",
  "‡§≤‡•ã‡§ï‡§æ‡§É":"lokw√ö","‡§∏‡§Æ‡§∏‡•ç‡§§‡§æ‡§É":"sm√°qw√ö","‡§∏‡•Å‡§ñ‡§ø‡§®‡•ã":"suiKno","‡§≠‡§µ‡§®‡•ç‡§§‡•Å":"BvNqu",

  "‡§°‡•â‡§ï‡•ç‡§ü‡§∞":"f‡•â#tr","‡§∏‡•ç‡§∞":"sR","‡§ï‡•ç‡§≤":"‚Ä∫"
};

/* ============================================================
   USER_MAP MERGE ‚Äì for new mappings saved from UI
   (merged into MAP_CONJ before we build KEY arrays)
============================================================ */
let USER_MAP = {};
try {
  const stored = localStorage.getItem("userMappings");
  if (stored) USER_MAP = JSON.parse(stored);
} catch (e) {
  USER_MAP = {};
}
for (const k in USER_MAP) {
  MAP_CONJ[k] = USER_MAP[k];
}

/* ============================================================
   PART 6 ‚Äì DERIVED HELPER SETS & CONSTANTS
============================================================ */
const WORD_KEYS     = Object.keys(MAP_WORDS).sort((a,b)=>b.length - a.length);
const CONJ_KEYS     = Object.keys(MAP_CONJ).sort((a,b)=>b.length - a.length);
const CONJ_KEYS_ZWJ = Object.keys(MAP_CONJ_ZWJ).sort((a,b)=>b.length - a.length);

const CONJ_VALUES = new Set(Object.values(MAP_CONJ));
const HALF_VALUES = new Set([
  ...Object.values(MAP_HALFA),
  ...Object.values(MAP_HALFB)
]);

const MAX_CONJ_LEN = Math.max(...Array.from(CONJ_VALUES, v => v.length));
const MAX_HALF_LEN = Math.max(...Array.from(HALF_VALUES, v => v.length));

const SIMPLE_CONS_CHARS = new Set([
  "k","K","g","G","|","c","C","j","J","\\",
  "t","T","f","F","x","q","Q","d","D","n",
  "p","P","b","B","m","X","r","l","v","S",
  "‚Ä†","s","h"
]);

function isDevaConsonant(ch) {
  return /[‡§ï-‡§π‡•ò-‡•ô‡•ö‡•õ‡•ú‡•ù‡•û‡•ü]/.test(ch);
}

// Look ahead from the halant to see if ANY consonant appears
// (ignoring ZWJ/ZWNJ and matras/signs)
function hasNextConsonantAfterHalant(text, halantIndex) {
  for (let j = halantIndex + 1; j < text.length; j++) {
    const ch = text[j];
    if (ch === "\u200c" || ch === "\u200d") continue;
    if (isDevaConsonant(ch)) return true;
    if (!/[\u0900-\u097F]/.test(ch)) return false;
  }
  return false;
}

/* ============================================================
   PART 7 ‚Äì i-SWAP (rules a, b, c)
============================================================ */
function swapI(text) {
  let arr = text.split("");

  for (let i = 0; i < arr.length; i++) {
    if (arr[i] !== "i") continue;

    let posC = i - 1;
    if (posC < 0) continue;
    if (/\s/.test(arr[posC])) continue;

    let moved = false;

    // Rule (c): If just after conjunct ‚Üí move before conjunct
    for (let L = MAX_CONJ_LEN; L >= 1; L--) {
      const start = posC - L + 1;
      if (start < 0) continue;

      const cand = arr.slice(start, posC + 1).join("");
      if (CONJ_VALUES.has(cand)) {
        arr.splice(i, 1);
        arr.splice(start, 0, "i");
        i = start + 1;
        moved = true;
        break;
      }
    }
    if (moved) continue;

    if (!SIMPLE_CONS_CHARS.has(arr[posC])) continue;

    // Rule (b): look for half block before consonant
    let clusterStart = posC;
    const halfEnd = posC - 1;

    if (halfEnd >= 0) {
      for (let L = MAX_HALF_LEN; L >= 1; L--) {
        const start = halfEnd - L + 1;
        if (start < 0) continue;

        const cand = arr.slice(start, halfEnd + 1).join("");
        if (HALF_VALUES.has(cand)) {
          clusterStart = start;
          break;
        }
      }
    }

    // Rule (a/b): move i before clusterStart
    arr.splice(i, 1);
    arr.splice(clusterStart, 0, "i");
    i = clusterStart + 1;
  }

  return arr.join("");
}

/* ============================================================
   PART 8 ‚Äì REPH FIX (r` ‚Üí ~) with matra-aware behavior
============================================================ */
function fixReph(text) {
  let arr = text.split("");
  let i = 0;

  const MATRA_AFTER = new Set(["w","I","u","U","√∑","y","Y","o","O","‡•Ö"]);

  while (i < arr.length - 1) {
    if (arr[i] === "r" && arr[i + 1] === "`") {

      // CASE 1: chhoti i already swapped before consonant
      if (arr[i + 2] === "i") {
        const iIndex = i + 2;
        const consonantIdx = iIndex + 1;

        if (consonantIdx >= arr.length) {
          arr.splice(i, 3, "i", "~");
          continue;
        }

        let insertAt = consonantIdx + 1;
        while (insertAt < arr.length && MATRA_AFTER.has(arr[insertAt])) {
          insertAt++;
        }

        let target = insertAt;
        arr.splice(i, 2);
        target -= 2;
        if (target < 0) target = 0;
        arr.splice(target, 0, "~");
        continue;
      }

      // CASE 2: normal case ‚Äì consonant then matras
      let consonantIdx = i + 2;
      if (consonantIdx >= arr.length) {
        arr.splice(i, 2, "~");
        continue;
      }

      let insertAt = consonantIdx + 1;
      while (insertAt < arr.length && MATRA_AFTER.has(arr[insertAt])) {
        insertAt++;
      }

      let target = insertAt;
      arr.splice(i, 2);
      target -= 2;
      if (target < 0) target = 0;
      arr.splice(target, 0, "~");
      continue;
    }

    i++;
  }

  return arr.join("");
}

/* ============================================================
   PART 9 ‚Äì FULL UNICODE ‚Üí AMAR ENGINE WITH PRIORITY
============================================================ */
function fullUnicodeToAmar(text) {
  let out = "";
  let i = 0;

  outerLoop:
  while (i < text.length) {

    // 1. WORD EXCEPTIONS
    for (const w of WORD_KEYS) {
      if (text.startsWith(w, i)) {
        out += MAP_WORDS[w];
        i += w.length;
        continue outerLoop;
      }
    }

    // 2. CONJUNCTS (normal)
    for (const cj of CONJ_KEYS) {
      if (text.startsWith(cj, i)) {
        out += MAP_CONJ[cj];
        i += cj.length;
        continue outerLoop;
      }
    }

    // 2b. CONJUNCTS with ZWJ (e.g. ‡§§‡•ç‚Äç‡§∞, ‡§∏‡•ç‚Äç‡§µ)
    for (const cj of CONJ_KEYS_ZWJ) {
      if (text.startsWith(cj, i)) {
        out += MAP_CONJ_ZWJ[cj];
        i += cj.length;
        continue outerLoop;
      }
    }

    const ch = text[i];
    const next = text[i+1];

    // Skip ZWJ/ZWNJ in output
    if (ch === "\u200c" || ch === "\u200d") {
      i++;
      continue;
    }

    // 3 & 4. HALF A / HALF B with "any consonant after halant" rule
    if (next === "‡•ç") {
      const halfKey = ch + "‡•ç";
      const hasCons = hasNextConsonantAfterHalant(text, i + 1);

      if (hasCons && MAP_HALFA[halfKey]) {
        out += MAP_HALFA[halfKey];
        i += 2;
        continue;
      }

      if (!hasCons && MAP_HALFB[halfKey]) {
        out += MAP_HALFB[halfKey];
        i += 2;
        continue;
      }

      if (MAP_HALFA[halfKey]) {
        out += MAP_HALFA[halfKey];
        i += 2;
        continue;
      }
      if (MAP_HALFB[halfKey]) {
        out += MAP_HALFB[halfKey];
        i += 2;
        continue;
      }
    }

    // 5. SIMPLE LETTER
    if (MAP_LETTERS[ch] !== undefined) {
      out += MAP_LETTERS[ch];
    } else {
      out += ch;
    }

    i++;
  }

  out = swapI(out);
  out = fixReph(out);
  return out;
}

/* ============================================================
   PART 10 ‚Äì AMAR ‚Üí UNICODE REVERSE (best-effort)
============================================================ */
let MASTER_MAP = {};
for (const k in MAP_LETTERS) MASTER_MAP[k] = MAP_LETTERS[k];
for (const k in MAP_HALFB)   MASTER_MAP[k] = MAP_HALFB[k];
for (const k in MAP_HALFA)   MASTER_MAP[k] = MAP_HALFA[k];
for (const k in MAP_CONJ)    MASTER_MAP[k] = MAP_CONJ[k];
for (const k in MAP_WORDS)   MASTER_MAP[k] = MAP_WORDS[k];

let REVERSE_MAP = {};
for (const k in MASTER_MAP) {
  const v = MASTER_MAP[k];
  if (!REVERSE_MAP[v]) REVERSE_MAP[v] = k;
}
const REVERSE_KEYS = Object.keys(REVERSE_MAP).sort((a,b)=>b.length - a.length);

function amarToUnicode(text) {
  let out = "";
  let i = 0;
  while (i < text.length) {
    let matched = false;
    for (const key of REVERSE_KEYS) {
      if (text.startsWith(key, i)) {
        out += REVERSE_MAP[key];
        i += key.length;
        matched = true;
        break;
      }
    }
    if (!matched) {
      out += text[i];
      i++;
    }
  }
  return out;
}

/* ============================================================
   PART 11 ‚Äì ADD NEW USER MAPPING (modal) ‚Äì goes into MAP_CONJ
============================================================ */
function saveNewMapping() {
  const uni  = document.getElementById("modalUnicode").value.trim();
  const amar = document.getElementById("modalAmar").value.trim();
  const key  = document.getElementById("modalKey").value.trim();

  if (!uni || !amar) {
    alert("‚ùå Unicode and Amar cannot be empty.");
    return;
  }

  if (key !== CORRECT_KEY) {
    alert("‚ùå Incorrect password");
    return;
  }

  USER_MAP[uni] = amar;
  try {
    localStorage.setItem("userMappings", JSON.stringify(USER_MAP));
  } catch(e) {}

  MAP_CONJ[uni] = amar;
  if (!CONJ_KEYS.includes(uni)) {
    CONJ_KEYS.push(uni);
    CONJ_KEYS.sort((a,b)=>b.length - a.length);
  }

  alert(`‚úÖ Mapping Added:\n${uni} ‚Üí ${amar}`);
  closeAddMapping();
}

/* ============================================================
   PART 12 ‚Äì UI HANDLERS
============================================================ */
function handleUnicodeToAmar() {
  const u = document.getElementById("unicodeInput").value;
  const a = fullUnicodeToAmar(u);
  document.getElementById("amarOutput").value = a;
}

function handleAmarToUnicode() {
  const a = document.getElementById("amarOutput").value;
  const u = amarToUnicode(a);
  document.getElementById("unicodeInput").value = u;
}

function copyAmar() {
  const box = document.getElementById("amarOutput");
  box.select();
  document.execCommand("copy");
}

/* ============================================================
   PART 13 ‚Äì DOCX: Unicode ‚Üí Amar (keep structure)
============================================================ */
async function convertDocx() {
  const fileInput = document.getElementById("docxFile");
  if (!fileInput || !fileInput.files.length) {
    alert("Please choose a DOCX file.");
    return;
  }

  const file = fileInput.files[0];

  try {
    const arrayBuffer = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);

    const docFile = zip.file("word/document.xml");
    if (!docFile) {
      alert("This file does not look like a valid DOCX (word/document.xml missing).");
      return;
    }

    const xmlString = await docFile.async("string");

    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlString, "application/xml");

    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
      console.error("XML parse error:", xmlDoc.getElementsByTagName("parsererror")[0]);
      alert("Error reading DOCX XML structure.");
      return;
    }

    const W_NS = "http://schemas.openxmlformats.org/wordprocessingml/2006/main";
    let textNodes = xmlDoc.getElementsByTagNameNS(W_NS, "t");
    if (!textNodes || textNodes.length === 0) {
      textNodes = xmlDoc.getElementsByTagName("w:t");
    }

    for (let i = 0; i < textNodes.length; i++) {
      const node = textNodes[i];
      const original = node.textContent || "";
      const converted = fullUnicodeToAmar(original);
      node.textContent = converted;

      const runNode = node.parentNode; // <w:r>
      if (runNode) {
        let rPr = runNode.getElementsByTagNameNS(W_NS, "rPr")[0];
        if (!rPr) {
          rPr = xmlDoc.createElementNS(W_NS, "w:rPr");
          runNode.insertBefore(rPr, node);
        }

        const rFonts = xmlDoc.createElementNS(W_NS, "w:rFonts");
        rFonts.setAttribute("w:ascii", "AmrHindi");
        rFonts.setAttribute("w:hAnsi", "AmrHindi");
        rFonts.setAttribute("w:cs", "AmrHindi");
        rPr.appendChild(rFonts);
      }
    }

    const serializer = new XMLSerializer();
    const newXmlString = serializer.serializeToString(xmlDoc);

    zip.file("word/document.xml", newXmlString);

    const outBlob = await zip.generateAsync({
      type: "blob",
      mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    });

    const ts = new Date().toISOString().replace(/[^\d]/g, "").slice(0,14);
    const outName = file.name.replace(/\.docx$/i, "") + "_amar_" + ts + ".docx";

    saveAs(outBlob, outName);
    alert("DOCX converted successfully.");

  } catch (err) {
    console.error("DOCX conversion error:", err);
    alert("Error converting DOCX. The file may be protected or not a standard DOCX.");
  }
}
</script>

</body>
</html>

<script>
setInterval(() => {
  parent.postMessage({frameHeight: document.body.scrollHeight}, "*");
}, 500);
</script>

